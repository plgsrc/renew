// ---------------------------------------------------------------------
// sub3.cpp
// êÆå`èoóÕ
// ---------------------------------------------------------------------
#include <windows.h>
#include <stdio.h>
#include <process.h>
#include <stdlib.h>
#include <conio.h>
#include <io.h>
#include <string.h>
#include <ctype.h>
#include <malloc.h>
#include <fcntl.h>
#include <time.h>
#include <direct.h>
#include <errno.h>

#include <iostream>
#include <string>
using namespace std;

#include "struct.h"
#include "renew.h"

#include "main_e.h"
#include "sub1_e.h"
#include "sub2_e.h"
#include "sub3_e.h"

// ------------------------------------------------------------
struct S_TYPE debug_type_map[] = {
	{ T_IF,			"IF"		 },
	{ T_IF1,		"IF1"		 },
	{ T_IF2,		"IF2"		 },
	{ T_IF3,		"IF3"		 },
	{ T_IF4,		"IF4"		 },
	{ T_IF5,		"IF5"		 },
	{ T_IF6,		"IF6"		 },
	{ T_IFX,		"IFX"		 },

	{ T_ELSE,		"ELSE"		 },
	{ T_ELSE1,		"ELSE1"		 },
	{ T_ELSE2,		"ELSE2"		 },
	{ T_ELSE3,		"ELSE3"		 },
	{ T_ELSE4,		"ELSE4"		 },
	{ T_ELSE5,		"ELSE5"		 },
	{ T_ELSE6,		"ELSE6"		 },
	{ T_ELSE_BIG,	"ELSE_BIG"	 },
	{ T_ELSE_IF,	"ELSE_IF"	 },
	{ T_ELSEX,		"ELSEX"		 },

	{ T_MASK_MES,	"MASK_MES"	 },
	{ T_MES14,		"MES14"		 },
	{ T_MES15,		"MES15"		 },
	{ T_MES16,		"MES16"		 },
	{ T_MES17,		"MES17"		 },

	{ T_SWITCH,		"SWITCH"	 },
	{ T_SWITCH1,	"SWITCH1"	 },
	{ T_SWITCH2,	"SWITCH2"	 },
	{ T_SWITCH3,	"SWITCH3"	 },
	{ T_SWITCH4,	"SWITCH4"	 },
	{ T_SWITCH5,	"SWITCH5"	 },
	{ T_SWITCH6,	"SWITCH6"	 },
	{ T_SWITCHX,	"SWITCHX"	 },

	{ T_CASE,		"CASE"		 },
	{ T_CASE1,		"CASE1"		 },
	{ T_CASE2,		"CASE2"		 },
	{ T_CASE3,		"CASE3"		 },
	{ T_DEFAULT1,	"DEFAULT1"	 },
	{ T_DEFAULT2,	"DEFAULT2"	 },
	{ T_DEFAULT3,	"DEFAULT3"	 },

	{ T_WHILE,		"WHILE"		 },
	{ T_WHILE1,		"WHILE1"	 },
	{ T_WHILE2,		"WHILE2"	 },
	{ T_WHILE3,		"WHILE3"	 },
	{ T_WHILE4,		"WHILE4"	 },
	{ T_WHILE5,		"WHILE5"	 },
	{ T_WHILE6,		"WHILE6"	 },
	{ T_WHILEX,		"WHILEX"	 },

	{ T_DO,			"DO"		 },
	{ T_DO1,		"DO1"		 },
	{ T_DO2,		"DO2"		 },
	{ T_DO3,		"DO3"		 },
	{ T_DO4,		"DO4"		 },
	{ T_DO5,		"DO5"		 },
	{ T_DO6,		"DO6"		 },
	{ T_DOX,		"DOX"		 },

	{ T_FOR,		"FOR"		 },
	{ T_FOR1,		"FOR1"		 },
	{ T_FOR2,		"FOR2"		 },
	{ T_FOR3,		"FOR3"		 },
	{ T_FOR4,		"FOR4"		 },
	{ T_FOR5,		"FOR5"		 },
	{ T_FORX,		"FORX"		 },

	{ T_RETURN,		"RETURN"	 },
	{ T_RETURN1,	"RETURN1"	 },
	{ T_RETURN2,	"RETURN2"	 },
	{ T_RETURN3,	"RETURN3"	 },
	{ T_RETURN4,	"RETURN4"	 },

	{ T_BIG_KAKKO,	"BIG_KAKKO"  },

	{ T_TYPE,		"TYPE"		 },
//	{ T_INT,		"INT"		 },
//	{ T_CHAR,		"CHAR"		 },
//	{ T_SHORT,		"SHORT"		 },
//	{ T_LONG,		"LONG"		 },
//	{ T_BOOL,		"BOOL"		 },
//	{ T_VOID,		"VOID"		 },
	{ T_OTHER_TYPE, "OTHER_TYPE" },

	{ T_STRUCT,		"STRUCT"	 },
	{ T_STRUCT1,	"STRUCT1"	 },
	{ T_STRUCT2,	"STRUCT2"	 },
	{ T_STRUCT3,	"STRUCT3"	 },
	{ T_STRUCT4,	"STRUCT4"	 },
	{ T_STRUCT5,	"STRUCT5"	 },
	{ T_STRUCT6,	"STRUCT6"	 },
	{ T_STRUCTX,	"STRUCTX"	 },

	{ T_UNION,		"UNION"		 },
	{ T_UNION1,		"UNION1"	 },
	{ T_UNION2,		"UNION2"	 },
	{ T_UNION3,		"UNION3"	 },
	{ T_UNION4,		"UNION4"	 },
	{ T_UNION5,		"UNION5"	 },
	{ T_UNION6,		"UNION6"	 },

	{ T_DEFIF,		"DEFIF"		 },
	{ T_DEF_IF1,	"DEF_IF1"	 },
	{ T_DEF_IF2,	"DEF_IF2"	 },

	{ T_DEF_ELSE,	"DEF_ELSE"	 },
	{ T_DEF_ELSE1,	"DEF_ELSE1"  },
	{ T_DEF_ELSE2,	"DEF_ELSE2"  },

	{ T_DEF_END,	"DEF_END"	 },
	{ T_DEF_END1,	"DEF_END1"	 },
	{ T_DEF_END2,	"DEF_END2"	 },

	{ T_DEFINE,		"DEFINE"	 },
	{ T_DEFINE1,	"DEFINE1"	 },
	{ T_DEFINE2,	"DEFINE2"	 },
	{ T_DEFINE3,	"DEFINE3"	 },
	{ T_DEFINEX,	"DEFINEX"	 },

	{ T_DEF_ANO,	"DEF_ANO"	 },

	{ T_TYPEDEF,	"TYPEDEF"	 },

	{ T_CALL,		"CALL"		 },

//	{ T_EXTERN,		"EXTERN"	 },
	{ T_INCLUDE,	"INCLUDE"	 },
	{ T_PRAGMA,		"PRAGMA"	 },
	{ T_DEF_OTHER,	"DEF_OTHER"  },

	{ T_CRLF,		"CRLF"		 },
	{ T_PROC,		"PROC"		 },
	{ T_MULTI,		"MULTI"		 },
	{ T_B_K_PAIR,	"B_K_PAIR"	 },
	{ T_SEMIKOLON,	"SEMIKOLON", },
	{ T_MOJIS,		"MOJIS",	 },
	{ T_DIGIT,		"DIGIT"		 },

	{ T_TYPE_IN,	"TYPE_IN"	 },
	{ T_O_DEF_IN,	"O_DEF_IN"	 },
	{ T_STRUCT_IN,	"STRUCT_IN"  },
	{ T_UNION_IN,	"UNION_IN"	 },
	{ T_OTHER_IN,	"OTHER_IN"	 },

	{ T_COM_MES,	"COM_MES"	 },

	{ T_OTHER,		"OTHER"		 },
	{ T_RENZOKU,	"RENZOKU"	 },
	{ T_ASM,		"ASM"		 },

//	{ G_TAB_EN,		"TAB_EN"	 },
	{ 0,			""			 }
};

// ----------------------------------------------
// ââéZéqÇ©ÇÃåüç∏
// return 0:ñ≥å¯, 1:óLå¯
// ----------------------------------------------
// int ismath( char *moji_buf )
// {
//	if( moji_buf[1] == 0 )
//	{
//		if( moji_buf[0] == '*' || moji_buf[0] == '/' || moji_buf[0] == '+' || moji_buf[0] == '-' ) return( 1 );
//		else return( 0 );
//	}
//	else return( 0 );
// }
// ====================================================================
// Åyã@î\ÅzintÇ±Ω∑∞Ç…ïœä∑
// Åyì¸óÕÅzobj_data	: å≥ÇÃ√ﬁ∞¿
// Åyì¸óÕÅz*d_str	: ïœä∑å„ÇÃé˚î[êÊ
// Åyì¸óÕÅzlen		: ïœä∑å„ÇÃí∑Ç≥(max 10)
// ÅyèoóÕÅzÇ»Çµ
// ÅyîıçlÅz
// ====================================================================
// void int_asc( int obj_data, char *d_str, int len )
// {
//	int		n;
//	char	buf[20];
//
//	_itoa( obj_data, buf, 10 );
//	n = (int)strlen( buf );
//	if( n < len )
//	{
//		memset( d_str, ' ', len - n );
//		memcpy( &d_str[len - n], buf, n );
//	}
//	else memcpy( d_str, buf, len );
// }
// ====================================================================
// Åyã@î\ÅzlongÇ±Ω∑∞Ç…ïœä∑
// Åyì¸óÕÅzobj_data	: å≥ÇÃ√ﬁ∞¿
// Åyì¸óÕÅz*d_str	: ïœä∑å„ÇÃé˚î[êÊ
// Åyì¸óÕÅzlen		: ïœä∑å„ÇÃí∑Ç≥(max 9)
// ÅyèoóÕÅzÇ»Çµ
// ÅyîıçlÅz
// ====================================================================
// void long_asc( long obj_data, char *d_str, int len )
// {
//	int		n;
//	char	buf[20];
//
//	_ltoa( obj_data, buf, 10 );
//	n = (int)strlen( buf );
//	if( n < len )
//	{
//		memset( d_str, ' ', len - n );
//		memcpy( &d_str[len - n], buf, n );
//	}
//	else memcpy( d_str, buf, len );
// }
// ====================================================================
// Åyã@î\Åz2word ÇÃ ﬁ≤≈ÿÇ±Ω∑∞Ç…ïœä∑(0Çïtâ¡)
// Åyì¸óÕÅzint obj_data, char *d_str
// ÅyèoóÕÅzÇ»Çµ
// ÅyîıçlÅz
// ====================================================================
// void obj_bcd8( int obj_data, char *d_str )
// {
//	static char hex_map[] = "0123456789ABCDEF";
//	int			i;
//	int			sign;
//
//	if( obj_data < 0 )
//	{ // œ≤≈Ω
//		obj_data = labs( obj_data );
//		sign = 1;
//	}
//	else sign = 0;
//
//	i = 8;
//	while( i-- )
//	{
//		if( i == 0 && sign ) d_str[0] = '-';
//		else {
//			d_str[i] = hex_map[obj_data % 10];
//			obj_data = obj_data / 10;
//		}
//	}
// }
// ---------- nåÖ(MAX=8)ÇÃBCDÇ2wordÇÃ ﬁ≤≈ÿÇ…ïœä∑ ----------
// int bcd_obj8( char *s_buf )
// {
//	int		obj_data;
//	int		i;
//	char	moji;
//
//	obj_data = 0L;
//	for( i = 0; i < 8; i++ )
//	{
//		moji = s_buf[i];
//		if( moji >= '0' && moji <= '9' ) obj_data = ( obj_data * 10 ) + ( moji & 0xf ); // 0Å`9
//		else return( obj_data );
//	}
//	return( obj_data );
// }
// --------------------------------------------------
int get_key( void )
{
	// ∑¨◊∏¿∞∫∞ƒﬁÇ™0x00ÇÃÇ∆Ç´ÇÕ§Ω∑¨›∫∞ƒﬁÇì«ÇﬁÇÊÇ§Ç…Ç»Ç¡ÇƒÇÈ
	int keydata;

	keydata = getchar();
	if( keydata == -1 ) return( -1 );

	return( keydata & 0xff );
}
// -------------- ï∂éöÇÃcheck -------------------------
int moji_check( char moji )
{
	int c;

	c = (int)moji & 0xff;
	if( c < ' ' ) return( 1 );									// control code
	if( c < 0x7f ) return( 2 );									// print code
	if( c == 0x7f ) return( 4 );								// delete code
//	if( (c & 0xe0) == 0x80 || (c & 0xe0) == 0xe0 ) return( 8 ); // kanji
	if( (c >= 0x81) && c <= 0x84 ) return( 8 );					// ShiftJIS äøéö
	if( (c >= 0x87) && c <= 0x9F ) return( 8 );					// ShiftJIS äøéö
	if( (c >= 0xE0) && c <= 0xE9 ) return( 8 );					// ShiftJIS äøéö
	if( (c >= 0xED) && c <= 0xEE ) return( 8 );					// ShiftJIS äøéö
	if( (c >= 0xA1) && c <= 0xDF ) return( 0x10 );				// ShiftJIS îºäpÉJÉi
	return( 0x20 );												// ÇªÇÃëº
}
// ---------------------------------------------------------
int _isalpha( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isalpha(moji) );
}
// ---------------------------------------------------------
int _isupper( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isupper(moji) );
}
// ---------------------------------------------------------
int _islower( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( islower(moji) );
}
// ---------------------------------------------------------
int _isdigit( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isdigit(moji) );
}
// ---------------------------------------------------------
int _isxdigit( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isxdigit(moji) );
}
// ---------------------------------------------------------
int _isspace( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isspace(moji) );
}
// ---------------------------------------------------------
int _ispunct( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( ispunct(moji) );
}
// ---------------------------------------------------------
int _isalnum( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isalnum(moji) );
}
// ---------------------------------------------------------
int _isprint( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isprint(moji) );
}
// ---------------------------------------------------------
int _isgraph( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( isgraph(moji) );
}
// ---------------------------------------------------------
int _iscntrl( int moji )
{
	moji &= 0xff;
	if( moji < 0 || moji > 255 ) return( 0 );
	else return( iscntrl(moji) );
}
//
// ====================================================================
// Åyã@î\Åz1byteÇÃ ﬁ≤≈ÿÇ2åÖÇÃBCDÇ…ïœä∑
// Åyì¸óÕÅz ﬁ≤≈ÿ√ﬁ∞¿,èëÇ´çûÇ› ﬁØÃß
// ÅyèoóÕÅzÇ»Çµ
// ÅyîıçlÅz
// ====================================================================
//
void obj_bcd2( int obj_data, char *wr_buf )
{
	wr_buf[1] = hex_map[obj_data % 10];
	obj_data /= 10;
	wr_buf[0] = hex_map[obj_data % 10];
}
// ---------------------------------------------------------
//	debugóp t_typeï∂éöÇìæÇÈ
//	“Øæ∞ºﬁÇÕ10ï∂éöå≈íËÇ…Ç∑ÇÈ
// ---------------------------------------------------------
void get_debug_type_map( char *d_buf, int t_type )
{
	int n;

	for( n = 0; debug_type_map[n].t_type; n++ )
	{
		if( debug_type_map[n].t_type == t_type ) break;
	}
	if( debug_type_map[n].name[0] ) sprintf( d_buf, "%-10s", debug_type_map[n].name );
	else {
		if( t_type ) sprintf( d_buf, "[%08x]", t_type );	// 10ï∂éöå≈íË
		else strcpy( d_buf, "[       0]" );					// 0
	}
}
// ------------------------------------------------------------------
// bufferì‡ÇÃï∂éöóÒÇÃêÿÇËèoÇµ
// mode 0: cur_moji_type <- tmp_moji_type
// mode 1: tmp_moji_type égóp
// max í∑Ç≥ÇÕ100ï∂éöÇ‹Ç≈
// return s_bufÇÃéüÇÃà íu
// ------------------------------------------------------------------
int get_tok1( int mode, char *d_buf, char *s_buf, int *tok_len )
{
	int		src_cnt, put_cnt, max_len, loop_type, len, flag, k_cnt, n;
	char	moji;

	k_cnt = 0;
	*tok_len = 0;
	put_cnt = 0;
	max_len = CHAR_SIZE - 3;

	src_cnt = pass_space( s_buf ); //  ﬂΩ ΩÕﬂ∞Ω,TAB
	flag = 0;
	while( (moji = s_buf[src_cnt]) != 0 )
	{
		if( flag == 0 )
		{ // èââÒ
			flag = 1;
			if( moji == 0x22 || moji == 0x27 ) break;
			if( _isdigit(moji) ) break;
			if( moji_check(moji) == 8 && s_buf[src_cnt + 1] ) break; // äøéö
			if( _isalpha(moji) || moji == '_' || moji == '#' )
			{ // ï∂éöóÒ
				d_buf[put_cnt++] = moji;
				src_cnt++;
				flag = 2; // ï∂éöóÒ
			}
			else { // ÇªÇÃëº
				d_buf[put_cnt++] = moji;
				src_cnt++;
			}
		}
		else if( flag == 1 )
		{ // í èÌ
			if( moji == _SOH || moji == ' ' ) break;
			else {
				d_buf[put_cnt++] = moji;
				src_cnt++;
				if( put_cnt == 2 )
				{
					if( d_buf[0] == '/' || d_buf[1] == '*' ) break;
					if( d_buf[0] == '*' || d_buf[1] == '/' ) break;
				}
				if( moji_check(moji) == 8 && s_buf[src_cnt + 1] ) break;	// äøéö
				if( put_cnt > 8 ) break;									// ó\ñÒåÍÇÕ,8ï∂éöÇ™ç≈ëÂ(unsigned)
			}
		}
		else { // ï∂éöóÒ
			if( moji_check(moji) == 8 )
			{
				src_cnt++; // äøéö
				break;
			}
			else if( _isalpha(moji) || _isdigit(moji) || moji == '_' || moji == '.' || moji == '#' )
			{
				d_buf[put_cnt++] = moji;
				src_cnt++;
			}
			else break;
		}
	}
	d_buf[put_cnt] = 0;
	if( flag == 1 ) flag = 0;							// ì¡éÍ(ïîï™àÍív)
	else flag = 1;										// ëSêîàÍív
	tmp_moji_type = search_yoyaku( flag, d_buf, &len ); // ó\ñÒï∂éöÇíTÇ∑
	if( tmp_moji_type == C_COM1 )
	{
		src_cnt = strlen( s_buf );
	}
	else if( tmp_moji_type == C_COM2 )
	{ // "/*Å`*/"
		src_cnt = search_end_comment( s_buf ); // "*/"ÇíTÇ∑, return å©Ç¬ÇØÇΩà íu(-1=Ç»Çµ)
		if( src_cnt >= 0 )
		{
			src_cnt += 2;
			while( (moji = s_buf[src_cnt]) != 0 )
			{ // éüÇÃΩÕﬂ∞ΩÇ‹Ç≈ ﬂΩ
				if( moji == _SOH || moji == ' ' ) break;
				src_cnt++;
			}
		}
		else {
			src_cnt = strlen( s_buf );	// ç≈å„Ç‹Ç≈Ç»Çµ
			tmp_moji_type = C_COM1;		// "/* Å`"(LFÇÃëOÇ‹Ç≈)
		}
	}
	else if( tmp_moji_type == C_COM3 )
	{ // "Å`*/"
		src_cnt = pass_space( s_buf ) + len; //  ﬂΩ ΩÕﬂ∞Ω,TAB
	}
	else if( tmp_moji_type )
	{ // òAë±ê´Ç†ÇËÇÃåüç∏
		// -------------- êÿÇËèoÇµÇÃç≈å„ÇÃà íuÇíTÇ∑ ------------------
		src_cnt = pass_space( s_buf ) + len; //  ﬂΩ ΩÕﬂ∞Ω,TAB
		if( (tmp_moji_type & C_MASK_TYPE1) && s_buf[src_cnt] == '*' )
		{ // ë±ÇØÇƒ'*' or "**"
			while( s_buf[src_cnt] == '*' ) src_cnt++; // "*" ﬂΩ
			while( (moji = s_buf[src_cnt]) != 0 )
			{ // TAB,ΩÕﬂ∞ΩÇ‹Ç≈
				if( moji == _SOH || moji == ' ' ) break;
				tmp_moji_type = C_OTHER;
				src_cnt++;
			}
		}
		else if( tmp_moji_type == C_KOME || tmp_moji_type == C_W_KOME || tmp_moji_type == C_AND )
		{ // '*' or "**" or "&"ÇÃå„ÇíTÇ∑
			moji = s_buf[src_cnt];
			if( _isalpha(moji) || moji == '_' )
			{
				tmp_moji_type = C_OTHER;
				do {
					moji = s_buf[++src_cnt]; // copy
				} while( !(moji == _SOH || moji == ' ' || moji == 0) );
				tmp_moji_type = C_OTHER;
			}
		}
		else if( tmp_moji_type == C_PLUS || tmp_moji_type == C_MINUS )
		{
			moji = s_buf[src_cnt];
			if( _isdigit(moji) || _isalpha(moji) )
			{
				if( _isdigit(moji) ) tmp_moji_type = C_DIGIT;
				else tmp_moji_type = C_OTHER;
				do {
					moji = s_buf[++src_cnt]; // copy
				} while( !(moji == _SOH || moji == ' ' || moji == 0) );
			}
		}
	}
	else { // ç≈èâÇ©ÇÁíTÇ∑(ÇªÇÃëº)
		tmp_moji_type = 0;
		loop_type = 0;
		src_cnt = pass_space( s_buf ); //  ﬂΩ ΩÕﬂ∞Ω,TAB
		while( (moji = s_buf[src_cnt]) != 0 )
		{
			if( (loop_type != C_WMOJI && loop_type != C_SMOJI) && (moji == _SOH || moji == ' ') ) break;
			switch( loop_type )
			{
			case 0: // ç≈èâÇÃï∂éö
				if( moji_check(moji) == 8 && s_buf[src_cnt + 1] )
				{
					src_cnt++;				// äøéö
					loop_type = C_ILLEGAL;	// ÇªÇÃëº
				}
				else if( moji == 0x22 ) loop_type = C_WMOJI;	// """
				else if( moji == 0x27 ) loop_type = C_SMOJI;	// "'"
				else if( _isdigit(moji) ) loop_type = C_DIGIT;
				else loop_type = C_OTHER;						// ÇªÇÃëº
				tmp_moji_type = loop_type;
				break;

			case C_WMOJI: // '"'
				if( moji == _LF )
				{
					tmp_moji_type = C_ILLEGAL;	// à‚ñ@
					loop_type = -1;				// íÜé~
					break;
				}
				if( moji_check(moji) == 8 && s_buf[src_cnt + 1] ) src_cnt++; // äøéö
				else if( moji == 0x5c )
				{ // '\\'
					if( s_buf[src_cnt + 1] == 'n' || s_buf[src_cnt + 1] == 'r' || s_buf[src_cnt + 1] == 't' ) src_cnt++;
					else if( (s_buf[src_cnt + 1] == _LF || s_buf[src_cnt + 1] == 0) )
					{
						tmp_moji_type = C_ILLEGAL; // à‚ñ@
						src_cnt++;
						loop_type = -1;
					}
					else src_cnt++; // '\"'
				}
				else if( moji == 0x22 )
				{ // '\"'
					src_cnt++;
					loop_type = -1;
				}
				break;

			case C_SMOJI: // ''' íPì∆ï∂éö
				if( moji == _LF )
				{
					tmp_moji_type = C_ILLEGAL;	// à‚ñ@
					loop_type = -1;				// íÜé~
					break;
				}
				if( moji_check(moji) == 8 && s_buf[src_cnt + 1] ) src_cnt++; // äøéö
				else if( moji == 0x5c )
				{ // '\\'
					if( s_buf[src_cnt + 1] == 0x5c || s_buf[src_cnt + 1] == 'n' ||
						s_buf[src_cnt + 1] == 'r' || s_buf[src_cnt + 1] == 't' ) src_cnt++; // '\"'
				}
				else if( moji == 0x27 )
				{ // '''
					src_cnt++;
					loop_type = -1;
				}
				break;

			case C_DIGIT: // êîéö
				break;

			case C_OTHER: // moji
			case C_ILLEGAL:
				if( moji_check(moji) == 8 && s_buf[src_cnt + 1] )
				{
					src_cnt++; // äøéö
					if( tmp_moji_type != C_ILLEGAL ) loop_type = tmp_moji_type = C_ILLEGAL;
				}
				else if( !(_isalpha(moji) || _isdigit(moji) || moji == '_' || moji == '#' ||
					moji == '-' || moji == '>' || moji == '<' || moji == ':' ||
					moji == '.' || moji == '*' || moji == '[' || moji == ']') ) loop_type = -1; // CR,LFìô
				break;

			default:
				break;
			}
			if( loop_type < 0 ) break;
			src_cnt++;
		}
		if( tmp_moji_type == 0 ) tmp_moji_type = C_OTHER; // ÇªÇÃëº
	}

	n = pass_space( s_buf ); //  ﬂΩ ΩÕﬂ∞Ω,TAB
	if( (src_cnt - n) > 0 )
	{
		memcpy( d_buf, &s_buf[n], src_cnt - n );	// copy comment
		d_buf[src_cnt - n] = 0;
		cut_last_space( 1, d_buf );					// ç≈å„ÇÃTAB,spaceÇçÌèú
		*tok_len = strlen( d_buf );
	}
	else *tok_len = 0;
	if( src_cnt == 0 || *tok_len == 0 ) tmp_moji_type = 0;	// reset

	if( mode == 0 ) cur_moji_type = tmp_moji_type;			// set
	return( src_cnt );
}
// ----------------------------------------------------------------------------
// ï∂éöóÒÇÃífï–ÇÃêÿÇËèoÇµ(s_bufÇÕç≈å„Ç™LFÇ»ÇµÇ…å¿ÇÈ)
// ΩÕﬂ∞Ω,TAB,ï™ó£ãLçÜÇ‹Ç≈ÇÃêÿÇËèoÇµ
// return s_bufÇÃéüÇÃà íu
// ----------------------------------------------------------------------------
int get_tok2( char *tok_buf, char *s_buf, int *tok_len )
{
	int put_cnt, max_len, pos, k_cnt, back_pos, digit_flag, n;

	max_len = CHAR_SIZE - 3;
	digit_flag = 0;
	k_cnt = 0;
	put_cnt = 0;
	pos = 0;
	for(;;)
	{ // cur_moji_typeÇÕä˘Ç…éÊÇËçûÇ›äÆóπ
		back_pos = pos;
		if( pos == 0 )
		{ // ç≈èâ.typeÇÕç≈èâÇÃÇ‡ÇÃÇ∆Ç∑ÇÈ
			pos = get_tok1( 0, tok_buf, s_buf, &n );
			if( cur_moji_type == 0 || cur_moji_type == C_COM1 ) break;	// ∫“›ƒ
			tmp_moji_type = cur_moji_type;								// ç≈èâÇÃtype
			if( tmp_moji_type == C_DIGIT || tmp_moji_type == C_PLUS || tmp_moji_type == C_MINUS )
				digit_flag = 1;											// set
		}
		else {
			pos += get_tok1( 1, tok_buf, &s_buf[pos], &n );
			if( tmp_moji_type == 0 || tmp_moji_type == C_COM1 )
			{
				pos = back_pos;
				break; // ∫“›ƒ
			}
		}
		if( digit_flag == 1 )
		{
			if( tok_buf[n - 1] == ',' ) break;
			if( tmp_moji_type == C_DIGIT || tmp_moji_type == C_PLUS || tmp_moji_type == C_MINUS )
				continue;
			else { // êîéöÇÃòAë±èIÇÌÇË
				pos = back_pos; // ÇPÇ¬ñﬂÇ∑
				break;
			}
		}

		if( tmp_moji_type == C_K_L )
		{
			if( k_cnt >= 0 ) k_cnt++;
		}
		else if( tmp_moji_type == C_K_R ) k_cnt--;
		if( (s_buf[pos] == _SOH || s_buf[pos] == ' ') && k_cnt <= 0 ) break;
	}

	n = pass_space( s_buf ); //  ﬂΩ ΩÕﬂ∞Ω,TAB
	if( (pos - n) > 0 )
	{
		memcpy( tok_buf, &s_buf[n], pos - n ); // copy
		tok_buf[pos - n] = 0;
	}
	else tok_buf[0] = 0;

	*tok_len = strlen( tok_buf );
	if( *tok_len >= max_len ) err_trap_line( 2, -13, 0 ); // "TOK over"

	return( pos );
}
// --------------------------------------------------------
// ∫“›ƒÇÃéËëOÇ©∫“›ƒÃﬁ€Ø∏ÇÃêÿÇËèoÇµ(s_bufÇÕç≈å„Ç™LFÇ»ÇµÇ…å¿ÇÈ)
// "//"ÇÕç≈å„Ç‹Ç≈Ç™1Ãﬁ€Ø∏
// cur_moji_type: C_COM1, C_OTHER
// return s_bufÇÃéüÇÃposà íu
// --------------------------------------------------------
int get_tok3( char *tok_buf, char *s_buf, int *tok_len )
{
	int src_cnt, back_cnt, len;

	src_cnt = get_tok1( 0, tok_buf, s_buf, tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
	if( cur_moji_type == C_COM1 ) return( src_cnt );	// ∫“›ƒÇéÊÇËçûÇ›
	else if( *tok_len )
	{ // ∫“›ƒà»äO
		back_cnt = 0;
		do { // ∫“›ƒÇÃëOÇ‹Ç≈ ﬂΩ
			back_cnt = src_cnt; // ëﬁî
			src_cnt += get_tok1( 1, tok_buf, &s_buf[src_cnt], tok_len ); // ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
			if( tmp_moji_type == C_COM1 )
			{ // ∫“›ƒî≠å©
				src_cnt = back_cnt; // ñﬂÇ∑
				break;
			}
		} while( *tok_len );
		len = pass_space( s_buf ); //  ﬂΩ ΩÕﬂ∞Ω,TAB
		if( src_cnt - len > 0 )
		{
			memcpy( tok_buf, &s_buf[len], src_cnt - len ); // copy comment
			tok_buf[src_cnt - len] = 0;
		}
		else tok_buf[0] = 0;
		*tok_len = strlen( tok_buf );
		cur_moji_type = C_OTHER; // dummy
	}
	return( src_cnt );
}
// --------------------------------------------------------
// "{Å`}"ÇÃÉRÉsÅ[ÅB∫›œíPà Ç≈ãÊêÿÇÈ
// return s_bufÇÃéüÇÃposà íu
// cur_moji_type : C_KOMMA
// cur_moji_type : C_COM1
// cur_moji_type : C_BIG_K_L
// cur_moji_type : C_BIG_K_R
// cur_moji_type : 0
// --------------------------------------------------------
int get_tok4( char *tok_buf, char *s_buf, int *tok_len )
{
	int src_cnt, back_cnt, len, back_moji_type;

//	src_cnt = get_tok1( 0, tok_buf, s_buf, tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
//	if( cur_moji_type == C_COM1 ) return( src_cnt );	// ∫“›ƒÇéÊÇËçûÇ›
	src_cnt = 0;
	do { // ∫“›ƒÇÃëOÇ‹Ç≈ ﬂΩ
		back_cnt = src_cnt; // ëﬁî
		back_moji_type = cur_moji_type;
//		src_cnt += get_tok1( 0, tok_buf, &s_buf[src_cnt], tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
		src_cnt += get_tok2( tok_buf, &s_buf[src_cnt], tok_len );		// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
		if( cur_moji_type )
		{
			if( cur_moji_type == C_BIG_K_L || cur_moji_type == C_BIG_K_R || cur_moji_type == C_COM1 )
			{ // ãÊêÿÇËî≠å©
				if( back_cnt )
				{
					src_cnt = back_cnt; // ñﬂÇ∑
					cur_moji_type = back_moji_type;
				}
				break;
			}
			if( cur_moji_type == C_KOMMA ) break; // ãÊêÿÇËî≠å©
			if( tok_buf[*tok_len - 1] == ',' ) break;
		}
	} while( *tok_len );
	len = pass_space( s_buf ); //  ﬂΩ ΩÕﬂ∞Ω,TAB
	if( src_cnt - len > 0 )
	{
		memcpy( tok_buf, &s_buf[len], src_cnt - len ); // copy comment
		tok_buf[src_cnt - len] = 0;
	}
	else tok_buf[0] = 0;
	*tok_len = strlen( tok_buf );
//	cur_moji_type = tmp_moji_type;

	return( src_cnt );
}
// ---------------------------------------------------------------------
// '{'+∫“›ƒÇ»ÇÁ ﬂΩ
// return( next pos )
// ---------------------------------------------------------------------
int add_comment( char *s_buf )
{
	int		pos, tok_len;
	char	tok_buf[CHAR_SIZE];

	pos = get_tok1( 1, tok_buf, s_buf, &tok_len ); // ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
	if( tmp_moji_type == C_COM1 ) return( pos );
	return( 0 );
}
// ---------------------------------------------------------------------
// '{'Ç»ÇÁ ﬂΩ
// return( next pos )
// ---------------------------------------------------------------------
int add_b_k_l( char *s_buf )
{
	int		pos, tok_len;
	char	tok_buf[CHAR_SIZE];

	pos = get_tok1( 1, tok_buf, s_buf, &tok_len ); // ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
	if( tmp_moji_type != C_BIG_K_L ) pos = 0;

	return( pos );
}
// ---------------------------------------------------------------------
// #typedef ÇÃâêÕ
// return( next pos )
// ---------------------------------------------------------------------
int kaiseki_typedef( char *s_buf )
{
	int		target_pos, k_cnt, big_cnt, c_cnt, flag;
	int		pos, back_pos, tok_len;
	char	tok_buf[CHAR_SIZE];

	target_pos = pos = back_pos = 0;
	flag = k_cnt = big_cnt = 0;
	for( c_cnt = 0; c_cnt < (MAX_C_MAP - 1); c_cnt++ )
	{
		back_pos = pos;
		pos += get_block( 1, tok_buf, &s_buf[pos], &tok_len ); // ó’éûÇ≈1 blockéÊÇËçûÇ›
		if( tmp_moji_type == C_COM1 || tmp_moji_type == C_LF || tmp_moji_type == 0 ) break;
		else if( tmp_moji_type & (C_MASK_TYPE1 | C_MASK_TYPE2) )
		{
			if( s_buf[pos] == ';' && k_cnt == 0 && big_cnt == 0 && flag == 0 && target_pos == 0 )
			{
				target_pos = back_pos; // set
				break;
			}
			else continue; // ó\ñÒå„ÇÕ ﬂΩ
		}
		else if( tmp_moji_type == C_KOMMA )
		{
			if( k_cnt == 0 && big_cnt == 0 && target_pos ) break;
			continue;
		}
		else if( (tmp_moji_type & C_MASK_KAKKO) || tmp_moji_type == C_STRUCT )
		{
			target_pos = 0; // reset
			break;
		}
		else if( tmp_moji_type == C_BIG_K_L )
		{
			big_cnt++;
			if( k_cnt == 0 && big_cnt == 1 && flag == 0 ) target_pos = back_pos; // set
		}
		else if( tmp_moji_type == C_BIG_K_R ) big_cnt--;
		else if( k_cnt == 0 && big_cnt == 0 && flag == 0 ) target_pos = back_pos;	// set

		if( s_buf[pos] != ' ' && s_buf[pos] != _SOH ) flag = 1;						// ë±Ç´ÇÕ ﬂΩ
		else flag = 0;
	}

	return( target_pos );
}
// ---------------------------------------------------------------------
// ï°êîÇÃTYPE MACROÇ ﬂΩ ñ¢égóp
// return( next pos )
// ---------------------------------------------------------------------
int add_bind_macro( char *s_buf )
{
	int		pos, tok_len;
	char	tok_buf[CHAR_SIZE];

	pos = get_tok1( 1, tok_buf, s_buf, &tok_len ); // ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
	if( tmp_moji_type == C_OTHER )
	{
		get_tok1( 1, tok_buf, &s_buf[pos], &tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
		if( tmp_moji_type != C_OTHER ) pos = 0;			// reset
	}
	else pos = 0;

	return( pos );
}
// ---------------------------------------------------------------------
// type à»äOÇ©ÇÃåüç∏
// return 0:ñ≥å¯, 1:óLå¯
// ---------------------------------------------------------------------
int chk_type( char *s_buf )
{
	int		n, len;
	char	moji;

	len = strlen( s_buf );
	moji = s_buf[0];
	if( moji == '*' || moji == '&' || moji == ':' || moji == '[' || moji == ']' ) return( 0 );
	moji = s_buf[len - 1];
	if( moji == ',' || moji == ':' || moji == '[' || moji == ']' || moji == ';' ) return( 0 );
	for( n = 0; n < len - 1; n++ )
	{
		moji = s_buf[n];
		if( isalpha(moji) ) continue;
		if( isdigit(moji) ) continue;
		if( moji == '_' ) continue;
		if( moji == ',' ) return( 0 );
		if( moji == '[' ) return( 0 );
		if( moji == ']' ) return( 0 );
		if( moji == '(' ) return( 0 );
		if( moji == ')' ) return( 0 );
		if( moji == '.' ) return( 0 );
		if( moji == '=' ) return( 0 );
		if( moji == ':' ) return( 0 );
		if( moji == '+' ) return( 0 );
		if( moji == '-' ) return( 0 );
		if( moji == '-' ) return( 0 );
		if( moji == ';' ) return( 0 );
	}
	return( 1 ); // óLå¯
}
// ---------------------------------------------------------------------
// ï°êîÇÃMASK_TYPEÇ ﬂΩ ñ¢égóp
// return( next pos )
// ---------------------------------------------------------------------
int add_bind_type1( char *s_buf )
{
	int		pos, back_pos, before_back_pos, tok_len, mode;
	char	tok_buf[CHAR_SIZE], moji;

	mode = back_pos = pos = 0;
	for(;;)
	{
		before_back_pos = back_pos;								// ëﬁî
		back_pos = pos;											// ëﬁî
//		pos += get_tok1( 1, tok_buf, &s_buf[pos], &tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
		pos += get_block( 1, tok_buf, &s_buf[pos], &tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
		if( tok_len == 0 ) break;
//		if( tmp_moji_type & (C_MASK_TYPE1 | C_MASK_TYPE2) ) continue;
		if( tmp_moji_type & C_MASK_TYPE1 )
		{
			mode = 1; // ë±Ç´Ç†ÇË
		}
		else if( tmp_moji_type & C_MASK_TYPE2 )
		{
			if( mode == 0 ) mode = 2; // ë±Ç´Ç†ÇË
		}
		else if( tmp_moji_type == C_STRUCT || tmp_moji_type == C_UNION )
		{ // Ç±Ç±Ç‹Ç≈ä‹Çﬁ
			back_pos = pos;
			break;
		}
		moji = tok_buf[tok_len - 1];
		if( moji == ',' || moji == ':' || moji == '[' || moji == ']' ) break;
		moji = tok_buf[0];
		if( moji == '*' || moji == '&' || moji == ':' || moji == '[' || moji == ']' ) break;
		if( s_buf[pos] == ',' )
		{
//			back_pos = before_back_pos;
			break;
		}
		if( s_buf[pos] != ' ' && s_buf[pos] != _SOH )
		{
//			back_pos = before_back_pos;
			break;
		}
		if( tmp_moji_type == C_IQUAL )
		{ // 2Ç¬ëO
			back_pos = before_back_pos;
			break;
		}
		if( tmp_moji_type != C_OTHER )
		{ // 1Ç¬ëO
			if( mode == 2 ) break;	// çXêV
			else pos = back_pos;	// ñﬂÇ∑
			break;
		}
//		else {
//			back_pos = pos;
//			break;
//		}
	}
	pos = back_pos; // ïœçX

	return( pos );
}
// ---------------------------------------------------------------------
// ï°êîÇÃó\ñÒåÍÇ1Ç¬Ç…Ç∑ÇÈ
// çsÇÃç≈èâÇ©ÇÁí≤Ç◊ÇÈÇ±Ç∆
// return( next pos )
// ---------------------------------------------------------------------
int add_bind_type2( int tmp_line, char *s_buf )
{
	int		pos, back_pos, before_back_pos, tok_len, back_cur_moji_type, yuko_pos;
	char	tok_buf[CHAR_SIZE];

#ifdef _DEBUG
	if( tmp_line >= 53 )
	{
		debug_n = s_buf[0];
	}
#endif
	back_cur_moji_type = cur_moji_type; // ëﬁî
	before_back_pos = back_pos = pos = 0;
	yuko_pos = 0;
	pos = 0;
	for(;;)
	{
		before_back_pos = back_pos;
		back_pos = pos;											// ëﬁî
//		pos += get_tok1( 0, tok_buf, &s_buf[pos], &tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
		pos += get_tok2( tok_buf, &s_buf[pos], &tok_len );		// éüÇéÊÇËçûÇ›
		if( tok_len == 0 || cur_moji_type == C_COM1 || cur_moji_type == C_COM2 )
		{
			pos = before_back_pos; // ñﬂÇ∑
			break;
		}
		else if( cur_moji_type == C_STRUCT || cur_moji_type == C_UNION ) break;
		if( cur_moji_type & C_MASK_TYPE1 ) yuko_pos = pos; // ë±Ç´Ç†ÇË
		else if( cur_moji_type & C_MASK_TYPE2 )
		{
			if( yuko_pos == 0 ) yuko_pos = pos; // ë±Ç´Ç†ÇË
		}
		if( tmp_moji_type == C_IQUAL )
		{ // 2Ç¬ëO
			pos = before_back_pos;
			break;
		}
		else if( tmp_moji_type == C_K_R )
		{ // ñ≥å¯
			pos = yuko_pos;
//			pos = back_pos; // ñﬂÇ∑
			break;
		}
		else if( chk_type(tok_buf) == 0 )
		{
			pos = back_pos; // ñﬂÇ∑
			break;
		}
//		if( cur_moji_type != C_OTHER )
//		{
//			if( mode == 2 ) break;	// çXêV
//			else pos = back_pos;	// ñﬂÇ∑
//			break;
//		}
//		else {
//			pos = back_pos; // ñﬂÇ∑
//			break;
//		}
	}
	cur_moji_type = back_cur_moji_type; // ñﬂÇ∑

	return( pos );
}
// ---------------------------------------------------------------------
// #define ÇÃ2î‘ñ⁄ÇÃíËêîÇìæÇÈ
// s_buf mesage
// tok_len íËêîÇÃãÊêÿÇËÇÃí∑Ç≥
// return ΩÕﬂ∞ΩÇä‹ÇÒÇæãÊêÿÇËÇÃí∑Ç≥
// ---------------------------------------------------------------------
int get_define_no2( char *tok_buf, char *s_buf, int *tok_len )
{
	int k_cnt, mode, pos, back_pos;
	int back_cur_moji_type, len;

	pos = get_tok1( 0, tok_buf, s_buf, tok_len );
	if( cur_moji_type == 0 ) return( pos );
	if( cur_moji_type == C_COM1 ) return( pos );
	if( cur_moji_type == C_COM2 ) return( pos ); // "/*Å`*/"

	back_cur_moji_type = 0;
	mode = 0;
	k_cnt = 0;
	pos = 0;
	for(;;)
	{
		back_pos = pos;
		pos += get_tok2( tok_buf, &s_buf[pos], &len );	// éüÇéÊÇËçûÇ›
		if( len == 0 ) break;							// ñ≥
		if( back_cur_moji_type == 0 ) back_cur_moji_type = cur_moji_type;
//		if( cur_moji_type == C_YEN ) continue;
		if( cur_moji_type == C_COM1 )
		{ // éËëO
			pos = back_pos;
			break;
		}
		if( mode == 0 )
		{ // first
			if( cur_moji_type == C_COM2 ) mode = 1; // "/*Å`*/"
			else if( cur_moji_type == C_K_L || cur_moji_type == C_BIG_K_L )
			{
				k_cnt++;
			}
			else if( cur_moji_type == C_K_R || cur_moji_type == C_BIG_K_R )
			{
				k_cnt--;
			}

			if( k_cnt == 0 && s_buf[pos] == ' ' || s_buf[pos] == _SOH )
			{
				back_pos = pos;										// ñﬂÇ∑
				pos += get_tok1( 1, tok_buf, &s_buf[pos], &len );	// éüÇéÊÇËçûÇ›
				if( tmp_moji_type != C_YEN )
				{
					pos = back_pos; // ñﬂÇ∑
					break;			// 1âÒñ⁄
				}
			}
		}
	}
	cur_moji_type = back_cur_moji_type;
	if( pos )
	{
		memcpy( tok_buf, s_buf, pos );
		tok_buf[pos] = 0;
		len = pass_space( tok_buf );		//  ﬂΩ ΩÕﬂ∞Ω,TAB
		strcpy( tok_buf, &tok_buf[len] );	// shift
		cut_last_space( 1, tok_buf );		// ç≈å„ÇÃTAB,spaceÇçÌèú
		len = strlen( tok_buf );
	}
	else len = 0;

	*tok_len = len;
	return( pos );
}
// ---------------------------------------------------------------------
// s_bufÇÃΩÕﬂ∞Ω 1å¬í«â¡
// ---------------------------------------------------------------------
int add_space_one( int end_pos, char *s_buf )
{
	s_buf[end_pos++] = ' ';
	s_buf[end_pos] = 0;
	return( end_pos );
}
// ---------------------------------------------------------------------
// TABåvéZ é¿à íu
// ç≈í·1Ç¬ÇÕΩÕﬂ∞Ωí«â¡
// return : éüÇÃend_pos
// ---------------------------------------------------------------------
int arrange_tab_soh( int target_pos, int buf_end_pos, char *s_buf )
{
	int pos;

	if( target_pos <= buf_end_pos ) s_buf[buf_end_pos++] = ' ';
	else {
		pos = ( target_pos / 4 ) * 4; // TABÇÃäÓñ{à íu
		if( (pos - buf_end_pos) > 1 )
		{
			while( buf_end_pos < pos )
			{ // TABÇ≈ï‚Ç§
				s_buf[buf_end_pos++] = _SOH;
				if( buf_end_pos >= (CHAR_SIZE - 5) )
				{
					err_trap_line( 2, -36, 0 ); // "1çsÇ™í∑Ç∑Ç¨ÇÈ"
				}
			}
		}
		while( buf_end_pos < target_pos )
		{ // écÇËí[êîÇΩÕﬂ∞ΩÇ≈ñÑÇﬂÇÈ
			s_buf[buf_end_pos++] = ' ';
			if( buf_end_pos >= (CHAR_SIZE - 5) )
			{
				err_trap_line( 2, -36, 0 ); // "1çsÇ™í∑Ç∑Ç¨ÇÈ"
			}
		}
	}
	s_buf[buf_end_pos] = 0;

	return( buf_end_pos );
}
// ---------------------------------------------------------------------
// tab_posÇìWäJÇ∑ÇÈ
// mode = 0:"//"Çí«â¡ÇµÇ»Ç¢
// mode = 1:"//"+TAB(' ') Çí«â¡Ç∑ÇÈ
// mode = 2:TAB+ "//" Çí«â¡Ç∑ÇÈ
// mode = 3:"//"+' ' TABÇÕñ≥éã
// ---------------------------------------------------------------------
void open_tab_pos( int mode, int tmp_line )
{
	struct	FDATA *fdata_p;
	int		target_pos, end_pos;

	fdata_p = &ope_buf[tmp_line];

	end_pos = strlen( fdata_p->pri_comment );
	if( mode == 1 || mode == 3 )
	{ // ç≈èâÇ…TAB, TABñ≥éã ΩÕﬂ∞ΩÇÃÇ›
		if( end_pos ) fdata_p->pri_comment[end_pos++] = ' ';
		fdata_p->pri_comment[end_pos++] = '/';
		fdata_p->pri_comment[end_pos++] = '/';
		if( mode == 3 ) fdata_p->tab_pos = 0;
	}
	fdata_p->pri_comment[end_pos] = 0;

	// ---------ΩÕﬂ∞ΩÇì¸ÇÍÇÈ ---------------
	target_pos = fdata_p->tab_pos * 4;
	if( (target_pos - end_pos) > 0 ) end_pos = arrange_tab_soh( target_pos, end_pos, fdata_p->pri_comment );

	if( mode == 2 )
	{ // å„Ç…TAB
		if( end_pos && fdata_p->pri_comment[end_pos - 1] != _SOH && fdata_p->pri_comment[end_pos - 1] != ' ' ) fdata_p->pri_comment[end_pos++] = ' ';
		fdata_p->pri_comment[end_pos++] = '/';
		fdata_p->pri_comment[end_pos++] = '/';
	}
	fdata_p->pri_comment[end_pos] = 0;
}
// ---------------------------------------------------------------------
// pri_comment, tab_posÇìWäJÇ∑ÇÈ
// ---------------------------------------------------------------------
void open_tab_mes( int tmp_line )
{
	struct FDATA *fdata_p;

	fdata_p = &ope_buf[tmp_line];

#ifdef _DEBUG
	if( tmp_line >= 32 )
	{
		debug_n = (int)fdata_p->mes;
	}
#endif

	if( fdata_p->hojo_flag & H_MES17 )
	{ // å¥ï∂ÇÃÇ‹Ç‹
		open_tab_pos( 0, tmp_line );
	}
	else if( fdata_p->hojo_flag & (H_MES11 | H_MES14) )
	{ // "//"+TAB(' ')+program
		open_tab_pos( 1, tmp_line );
	}
	else if( fdata_p->hojo_flag & H_MES15 )
	{ // TAB+"//"+comments, programÇÃå„ÇÃ∫“›ƒÇ…çáÇÌÇπÇÈ
		open_tab_pos( 2, tmp_line );
	}
	else if( fdata_p->hojo_flag & H_MES16 )
	{ // "//"+' '+message TABÇÕñ≥éã
		open_tab_pos( 3, tmp_line );
	}
	else { // çsì™Ç…"//"í«â¡Ç»Çµ
		open_tab_pos( 0, tmp_line );
	}
}
// ---------------------------------------------------------------------
// if(), for(), while()Ç™ÇPçsÇ≈èIÇÌÇÈÇ©ÇÃåüç∏
// return 0:ÇPçsÇ≈èIÇÌÇÁÇ»Ç¢, 1:1çsÇ≈èIÇÌÇÈ
// ---------------------------------------------------------------------
int chk_loop_end( char *s_buf )
{
	int		pos, len, type, flag, k_cnt;
	char	tok_buf[CHAR_SIZE];

	k_cnt = 0;
	flag = 0;
	type = 0;
	pos = 0;
	for(;;)
	{
		pos += get_block( 1, tok_buf, &s_buf[pos], &len );	// éüÇéÊÇËçûÇ›
		if( tmp_moji_type == 0 || tmp_moji_type == C_COM1 ) break;
		else if( tmp_moji_type == C_SEMIKOLON ) flag = 1;	// set
		else if( tmp_moji_type == C_BIG_K_L ) flag = 0;		// reset
		else if( tmp_moji_type == C_K_L ) k_cnt++;
		else if( tmp_moji_type == C_K_R ) k_cnt--;
		else if( tmp_moji_type == C_BIG_K_R ) flag = 1;		// set
		else flag = 0;										// reset
	}
	if( k_cnt ) flag = 0;
	return( flag );
}
// ---------------------------------------------------------------------
// TABï‚ê≥ÇÃïKóvê´ÇämîF
// return 0:ñ≥å¯
// ---------------------------------------------------------------------
int chk_tab_enable( int now_line )
{
	int		line_type;
	struct	FDATA *fdata_p;

	fdata_p = &ope_buf[now_line];
	line_type = fdata_p->line_type;

	if( line_type == T_ASM ) return( G_ASM );				// óLå¯

	if( line_type == T_DEFINE ) return( G_DEFINE );			// óLå¯
	if( line_type == T_TYPEDEF ) return( G_TYPEDEF );		// óLå¯
	if( line_type == T_DEF_OTHER ) return( G_DEF_OTHER );	// óLå¯

	if( line_type == T_TYPE || line_type == T_OTHER_TYPE )
	{
		if( fdata_p->hojo_flag & H_B_K_PAIR ) return( G_TYPE2 );	// óLå¯
		else return( G_TYPE1 );										// óLå¯
	}

//	if( line_type == T_EXTERN ) return( G_EXTERN ); // óLå¯

	if( line_type == T_PROC ) return( G_PROC );		// óLå¯

	if( line_type == T_STRUCT || line_type == T_UNION )
	{
		if( fdata_p->hojo_flag & H_B_K_PAIR ) return( G_STRUCT2 );	// óLå¯
		else return( G_STRUCT1 );									// óLå¯
	}

	if( line_type == T_INCLUDE ) return( G_INCLUDE );	// óLå¯

	if( line_type & T_MASK_IN ) return( G_TYPE_IN );	// óLå¯

	if( line_type == T_DIGIT ) return( G_DIGIT );		// óLå¯
	if( line_type == T_MOJIS ) return( G_MOJIS );		// óLå¯

	if( line_type == T_B_K_PAIR ) return( G_B_K_PAIR ); // óLå¯

	if( line_type == T_CASE ) return( G_CASE );			// óLå¯

	if( line_type == T_OTHER ) return( G_OTHER );		// óLå¯
	if( line_type == T_CALL ) return( G_OTHER );		// óLå¯
	if( line_type == T_RETURN ) return( G_OTHER );		// óLå¯
	if( (line_type == T_WHILE || line_type == T_FOR) && chk_loop_end(fdata_p->mes) ) return( G_OTHER ); // óLå¯

	if( line_type == T_IF ) return( G_IF );			// óLå¯
	if( line_type == T_ELSE ) return( G_IF );		// óLå¯
	if( line_type == T_ELSE_BIG ) return( G_IF );	// óLå¯
	if( line_type == T_ELSE_IF ) return( G_IF );	// óLå¯

	return( 0 );									// ñ≥å¯
}
// ---------------------------------------------------------------------
// MES15ÇÃéüÇ™ìØÇ∂Ç©ÇÃåüç∏
// return 0:NG, 1~:OK(+skip line)
// ---------------------------------------------------------------------
int chk_same_teigi( int base_type, int skip_mes, int *line_no, int end_line )
{
	struct	FDATA *fdata_p;
	int		line, cnt;

	cnt = 0;
	line = *line_no;
	for( ; line < end_line; line++ )
	{
		fdata_p = &ope_buf[line];

		if( fdata_p->line_type == T_CRLF ) continue;
		if( fdata_p->hojo_flag & (H_YEN1 | H_YEN2) ) break;
		if( fdata_p->line_type == skip_mes )
		{
			if( ++cnt > 2 ) break; // 2çsÇ‹Ç≈OK
			continue;
		}
		if( base_type == chk_tab_enable(line) )
		{
			*line_no = line;	// set new
			return( 1 );		// óLå¯
		}
		else break;
	}
	return( 0 ); // ñ≥å¯
}
// ---------------------------------------------------------
// ø∞Ωï∂éöÇÃàÍívÇµÇ»Ç¢à íuÇíTÇ∑
// ∫“›ƒÇÃèÍçáÇÕ0Çï‘Ç∑
// end_pos : ±⁄›ºﬁå„ÇÃbufferÇÃà íu
// *s_buf : å≥ÇÃø∞Ω
// *t_buf : ±⁄›ºﬁå„ÇÃbuffer
// return : ø∞ΩÇÃà íu
// ---------------------------------------------------------
int get_source_pos( int end_pos, char *t_buf, char *s_buf )
{
	int		n, pos;
	char	moji;

	pos = 0;
	n = 0;
	while( (moji = t_buf[n]) != 0 )
	{
		if( moji != _SOH && moji != ' ' )
		{ // TAB,ΩÕﬂ∞Ω  ﬂΩ
			while( s_buf[pos] == _SOH || s_buf[pos] == ' ' ) pos++; // TAB,ΩÕﬂ∞Ω  ﬂΩ
			pos++;
		}
		if( ++n >= end_pos ) break;
	}
//	while( s_buf[pos] == _SOH || s_buf[pos] == ' ' ) pos++; // TAB,ΩÕﬂ∞Ω  ﬂΩ

	return( pos );
}
// ---------------------------------------------------------------------
// commentëOÇÃTABà íuÇçáÇÌÇπÇÈ
// ---------------------------------------------------------------------
int set_tab( int teigi_no, int line_start, int line_last, int max_pos )
{
	struct	FDATA *fdata_p;
	int		tmp_line, last_teigi_no, top_pos, end_pos, pos;
	char	buf[CHAR_SIZE];

	last_teigi_no = 0;
	for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
	{
		fdata_p = &ope_buf[tmp_line];

		if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ
		if( fdata_p->line_type & T_MASK_MES ) continue;
		if( fdata_p->line_type == T_COM_MES ) continue;
		if( (fdata_p->status[teigi_no] & ST_COM) && form_comment_prog == 0 ) continue;

#ifdef _DEBUG
		if( tmp_line >= 4150 && teigi_no >= 1 )
		{
			debug_n = tmp_line;
		}
#endif
		end_pos = fdata_p->top_pos[teigi_no] + fdata_p->block_len[teigi_no];	// lastà íu
		top_pos = end_pos + pass_space( &fdata_p->mes[end_pos] );				// éüÇÃtop
		if( end_pos && fdata_p->mes[top_pos] )
		{
//			get_tok1( 1, tok_buf, &fdata_p->mes[top_pos], &tok_len );
//			get_tok2( tok_buf, &fdata_p->mes[top_pos], &tok_len );										// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
			pos = max_pos;
			if( fdata_p->status[teigi_no] & (ST_PAIR_L | ST_PAIR_IN) ) pos = 1;							// ΩÕﬂ∞ΩÇÃÇ›óLå¯
			else if( (fdata_p->status[teigi_no] & ST_TAB) == 0 ) pos = 1;								// ΩÕﬂ∞ΩÇÃÇ›óLå¯
//			else {
//				if( (base_type & (G_DEFINE | G_DEF_OTHER | G_TYPEDEF)) == 0 && teigi_no >= 2 ) pos = 1; // ΩÕﬂ∞Ω
//				if( teigi_no == 1 )
//				{
//					if( bunpu_cnt <= 1 && (base_type & (G_DEFINE | G_DEF_OTHER | G_TYPEDEF)) == 0 &&
//						fdata_p->tab_pos == 0 && bunpu_cnt <= 1 && teigi_no == 1 ) pos = 1; // ΩÕﬂ∞Ω
//				}
//				else if( base_type != G_DEFINE && bunpu_cnt <= 1 ) pos = 1; // ΩÕﬂ∞Ω
//			}
			memcpy( buf, fdata_p->mes, end_pos );
			buf[end_pos] = 0;

			end_pos = arrange_tab_soh( pos, end_pos, buf );
			if( (teigi_no + 1) < MAX_TEIGI_NO )
			{
//				end_pos += pass_space( &fdata_p->mes[end_pos] );	// éüÇÃtop
				fdata_p->top_pos[teigi_no + 1] = end_pos;			// new set
				if( fdata_p->status[teigi_no] & (ST_PAIR_L | ST_PAIR_IN) )
					fdata_p->status[teigi_no + 1] |= ST_PAIR_IN;	// "{Å`}"ÇÃäJénà íu
			}
			strcat( buf, &fdata_p->mes[top_pos] );	// écÇËcopy
			strcpy( fdata_p->mes, buf );			// ñﬂÇ∑
			last_teigi_no = teigi_no;				// ë±çs
		}
		else if( (teigi_no + 1) < MAX_TEIGI_NO )
		{
			fdata_p->top_pos[teigi_no + 1] = 0;		// Ç»Çµ
			fdata_p->block_len[teigi_no + 1] = 0;	// Ç»Çµ
			fdata_p->status[teigi_no + 1] = 0;		// Ç»Çµ
		}
	}
	return( last_teigi_no );
}
// ---------------------------------------------------------------------
// ∫“›ƒÇÃèàóù
// ---------------------------------------------------------------------
void comment_syori( int base_type, int *line_start, int line_last )
{
	#define IF_DIFFER_TAB		40
	#define OTHER_DIFFER_TAB	40

	struct	FDATA *fdata_p;
	int		top_pos, end_pos, tmp_line, no_com_cnt, total, averrage;
	int		comment_mode, comment_cnt, line_same_com_pos, line_top;
	int		least_pos, max_pos, pos, com_teigi_no, n;
	char	buf[CHAR_SIZE2];

	line_top = *line_start;
	// ---------------- ∫“›ƒ ÇÃèàóù -----------------
	if( base_type & (G_DEFINE | G_DEF_OTHER | G_TYPEDEF) )
		comment_mode = form_define_com_tab; // #define ÇÃ∫“›ƒÇÃTABà íu 0:Ç»Ç…Ç‡ÇµÇ»Ç¢, 1:TABÇ»Çµ(ΩÕﬂ∞ΩÇÃÇ›), 2:é©ìÆÇ≈TABçÏê¨
	else {
		comment_mode = form_other_com_tab;	// ÇªÇÃëº 0:âΩÇ‡ÇµÇ»Ç¢, 1:TABÇ»Çµ(ΩÕﬂ∞ΩÇÃÇ›), 2:ç≈ëÂTABêßå¿Ç»Çµ
//		if( (base_type == G_CASE || base_type == G_DEFIF) && comment_mode == 2 ) comment_mode = 30; // max TAB = 30
		if( base_type == G_CASE && comment_mode == 2 ) comment_mode = 30;							// max TAB = 30
	}
	if( comment_mode == 0 ) return;
	// ---------- ∫“›ƒÇÃç≈ëÂ/ç≈è¨ílÀﬂ∞∏ílÇãÅÇﬂÇÈ -------------
	comment_cnt = 0; // ï™ïz
	least_pos = max_pos = 0;
	total = averrage = 0;
	no_com_cnt = -1; // ç≈èâÇÃ∫“›ƒï∂ÇíTÇ∑
	for( tmp_line = line_top; tmp_line < line_last; tmp_line++ )
	{
		fdata_p = &ope_buf[tmp_line];

		if( no_com_cnt >= 0 ) no_com_cnt++;
		if( fdata_p->line_type == T_CRLF ) continue;
		if( fdata_p->line_type & T_MASK_MES ) continue;

#ifdef _DEBUG
		if( tmp_line >= 846 )
		{
			debug_n = (int)fdata_p->mes;
		}
#endif
		com_teigi_no = fdata_p->com_teigi_no;
		if( com_teigi_no == 0 )
		{ // ∫“›ƒÇ»Çµ
			if( base_type != G_DEFINE && no_com_cnt >= 10 )
			{ // 10çsà»è„ÇÃ∫“›ƒÇ»Çµ
				line_last = tmp_line + 1;
				break; // àÍíUÇ±Ç±Ç≈Ç‹Ç∆ÇﬂÇÈ
			}
			continue;
		}
		if( no_com_cnt < 0 ) line_top = tmp_line; // ∫“›ƒÇÃç≈èâ

		end_pos = fdata_p->top_pos[com_teigi_no - 1] + fdata_p->block_len[com_teigi_no - 1];

		// ∫“›ƒÇÃTABà íu 0:âΩÇ‡ÇµÇ»Ç¢, 1:TABÇ»Çµ(ΩÕﬂ∞ΩÇÃÇ›), 2:é©ìÆÇ≈TABçÏê¨, 3Å`:ç≈ëÂTABà íu
		if( comment_mode > 1 )
		{ // îªíË
//			if( (end_pos > 0 && end_pos < MAX_END_MAP) && (fdata_p->status[com_teigi_no] & ST_TAB) )
			if( end_pos > 0 && end_pos < MAX_END_MAP )
			{
//				if( end_pos )
				n = ( (end_pos + 4) / 4 ) * 4; // é¿posà íuÇÃåvéZ.TABç≈è¨=1
//				else n = 0;
				if( comment_mode >= 3 && n > (comment_mode * 4) )
				{ // 0:âΩÇ‡ÇµÇ»Ç¢, 1:TABÇ»Çµ(ΩÕﬂ∞ΩÇÃÇ›), 2:é©ìÆÇ≈TABçÏê¨, 3Å`:ç≈ëÂà íu
					fdata_p->status[com_teigi_no] &= ~( ST_TAB );	// éwíËç≈ëÂílÇí¥Ç¶ÇΩÇÁΩÕﬂ∞ΩÇÃÇ›
//					n = 0;											// TABÇ»Çµ
				}
//				else if( fdata_p->line_type == T_DEFIF || fdata_p->line_type == T_DEF_OTHER )
				else if( fdata_p->line_type == T_DEFIF )
					fdata_p->status[com_teigi_no] &= ~( ST_TAB );	// ΩÕﬂ∞ΩÇÃÇ›
				else if( fdata_p->line_type != T_STRUCT_IN && fdata_p->line_type != T_UNION_IN &&
					((fdata_p->hojo_flag & (H_BIG_K_L | H_BIG_K_R)) == H_BIG_K_L ||
					(fdata_p->hojo_flag & (H_BIG_K_L | H_BIG_K_R)) == H_BIG_K_R) )
					fdata_p->status[com_teigi_no] &= ~( ST_TAB );	// ΩÕﬂ∞ΩÇÃÇ›
				else {
					if( ++comment_cnt == 1 ) total = averrage = n;	// èââÒ
					else {
						if( base_type & (G_DEFINE | G_DEF_OTHER | G_TYPEDEF) )
						{
							if( abs(averrage - n) > 40 )
							{ // ç°Ç‹Ç≈ÇÃçsÇÃîªíË
								line_last = tmp_line;
								break; // àÍíUÇ±Ç±Ç≈Ç‹Ç∆ÇﬂÇÈ
							}
						}
						else {
							if( abs(averrage - n) > 40 )
							{ // ç°Ç‹Ç≈ÇÃçsÇÃîªíË
								line_last = tmp_line;
								break; // àÍíUÇ±Ç±Ç≈Ç‹Ç∆ÇﬂÇÈ
							}
						}
						total += n;
						averrage = total / comment_cnt;
					}
					if( least_pos == 0 ) least_pos = end_pos;			// ç≈èâ
					else if( least_pos > end_pos ) least_pos = end_pos; // è¨Ç≥Ç¢à íuÇæØƒ
					if( max_pos < end_pos ) max_pos = end_pos;			// ëÂÇ´Ç¢à íuÇæØƒ
					fdata_p->status[com_teigi_no] |= ST_TAB;			// TABóLå¯
				}
			}
		}
		else { // 1:TABÇ»Çµ(ΩÕﬂ∞ΩÇÃÇ›)
			fdata_p->status[com_teigi_no] &= ~( ST_TAB ); // set space
		}
		no_com_cnt = 0; // reset
	}

	// ----------------- TABÇ™ÇPå¬ÇÃèÍçáÇÕëSÇƒΩÕﬂ∞ΩÇ∆Ç∑ÇÈ ------------------
	if( base_type != G_DEFINE && least_pos == max_pos )
	{
//		if( (line_last - line_top) >= 5 || comment_mode >= 3 ) max_pos = 0; // ΩÕﬂ∞ΩÇÃÇ›
		max_pos = 0; // ΩÕﬂ∞ΩÇÃÇ›
	}
	else max_pos = ( (max_pos + 4) / 4 ) * 4; // é¿posà íuÇÃåvéZ
	// ----------------- ∫“›ƒÇ…TAB,ΩÕﬂ∞ΩÇåàÇﬂÇÈ ------------------
	line_same_com_pos = 0;
	for( tmp_line = line_top; tmp_line < line_last; tmp_line++ )
	{
		fdata_p = &ope_buf[tmp_line];

#ifdef _DEBUG
		if( tmp_line >= 57 )
		{
			debug_n = 0;
		}
#endif

		if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ
		if( fdata_p->line_type & T_MASK_MES ) continue;
		com_teigi_no = fdata_p->com_teigi_no;
		if( com_teigi_no == 0 ) continue;

		top_pos = fdata_p->top_pos[com_teigi_no];
		end_pos = fdata_p->top_pos[com_teigi_no - 1] + fdata_p->block_len[com_teigi_no - 1];

		if( form_limit_line && (max_pos + fdata_p->block_len[com_teigi_no]) > (form_limit_line * 4) )
		{
			fdata_p->status[com_teigi_no] &= ~( ST_TAB ); // TABñ≥å¯
		}
		if( fdata_p->line_type == T_COM_MES && line_same_com_pos > 0 )
		{ // commentÇÃÇ›Ç≈ÅAëOçsÇ…çáÇÌÇπÇÈ
			pos = line_same_com_pos;					// 1Ç¬ëOÇÃà íu
			end_pos = 0;
			fdata_p->status[com_teigi_no] |= ST_TAB;	// TABóLå¯.ïKóv
		}
		else pos = max_pos;

		// é¿ç€ÇÃTABÇåàÇﬂÇÈ
		if( end_pos ) memcpy( buf, fdata_p->mes, end_pos );				// ∫“›ƒÇÃëOÇ‹Ç≈Ç∫Àﬂ∞
		if( (fdata_p->status[com_teigi_no] & ST_TAB) == 0 ) pos = 1;	// ΩÕﬂ∞ΩÇÃÇ›óLå¯
		end_pos = arrange_tab_soh( pos, end_pos, buf );
		line_same_com_pos = end_pos;

		if( end_pos )
		{
			strcat( buf, &fdata_p->mes[top_pos] );		// écÇËcopy
			fdata_p->top_pos[com_teigi_no] = end_pos;	// set new
			strcpy( fdata_p->mes, buf );				// ñﬂÇ∑
		}
	}

	*line_start = line_last;
}
// ---------------------------------------------------------------------
// '{'Å`'}'ÇÃíËêîÇÃç≈ëÂílÇí≤Ç◊ÇÈ
// mode = 0:'{'ÇÃÇ›, =1:'{'ÇÃéüÇ©ÇÁ
// ---------------------------------------------------------------------
void chk_const_pos( int mode, int line_start, int line_last )
{
	struct	FDATA *fdata_p;
	int		tmp_line, teigi_ofset, teigi_no, len, flag;

#ifdef _DEBUG
	if( line_start == 55 )
	{
		debug_n = 0;
	}
#endif
	if( mode == 0 ) pos_map[0] = 0;
	else memset( &pos_map[1], 0, sizeof(pos_map) - sizeof(int) );

	for( teigi_ofset = mode; teigi_ofset < MAX_TEIGI_NO; teigi_ofset++ )
	{ // '{'Ç©ÇÁëµÇ¶ÇÈà◊teigi_no = 0 Ç©ÇÁ
		// ------ ç≈ëÂílÇåüç∏ -------------
		flag = 0;
		for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
		{ // ç≈ëÂend_posåvéZ
			fdata_p = &ope_buf[tmp_line];
			if( fdata_p->pair_teigi_top == 0 ) continue;

			teigi_no = fdata_p->pair_teigi_top + teigi_ofset;	// mode = 0:'{' Ç©ÇÁ, =1:ÇªÇÃéüÇ©ÇÁ
			if( teigi_no >= MAX_TEIGI_NO ) continue;
			if( teigi_no > fdata_p->pair_teigi_end ) continue;	// '}' Ç‹Ç≈

			flag++;
			if( fdata_p->status[teigi_no] & (ST_SPACE | ST_TAB) )
			{
				len = fdata_p->block_len[teigi_no - 1];
				if( len )
				{
					if( pos_map[teigi_ofset] == 0 ) pos_map[teigi_ofset] = len;			// èâä˙æØƒ
					else if( pos_map[teigi_ofset] < len ) pos_map[teigi_ofset] = len;	// ç≈è¨í∑Ç≥ÇæØƒ
				}
			}
		}
		if( flag == 0 || mode == 0 ) break;
	}
}
// ---------------------------------------------------------------------
// '{'Å`'}'ÇÃé¿ç€ÇÃTABà íuÇåvéZ
// mode = 0:'{'ÇæÇØÇ†ÇÌÇπÇÈ, 1:'{'à»å„ÇÇ†ÇÌÇπÇÈ
// ret= 0:ê≥èÌ , 1:1çsover
// ---------------------------------------------------------------------
int chk_teigi_tab_max( int mode, int line_start, int line_last )
{
	struct	FDATA *fdata_p;
	int		tmp_line, teigi_ofset, teigi_no, end_pos, cnt, n;

#ifdef _DEBUG
	if( line_start == 166 )
	{
		debug_n = 0;
	}
#endif
	chk_const_pos( mode, line_start, line_last ); // íËêîÇÃç≈ëÂílÇí≤Ç◊ÇÈ
	if( mode == 0 ) total_pos[0] = 0;
	else memset( &total_pos[1], 0, sizeof(total_pos) - sizeof(int) );

	for( teigi_ofset = mode; teigi_ofset < MAX_TEIGI_NO; teigi_ofset++ )
	{ // '{'Ç©ÇÁëµÇ¶ÇÈà◊teigi_no = 0 Ç©ÇÁ
		// ------ ç≈ëÂílÇåüç∏ -------------
		cnt = 0;
		end_pos = 0;
		for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
		{ // ç≈ëÂend_posåvéZ
			fdata_p = &ope_buf[tmp_line];
			if( fdata_p->pair_teigi_top == 0 ) continue;

			teigi_no = fdata_p->pair_teigi_top + teigi_ofset;	// mode = 0:'{' Ç©ÇÁ, = 1:éüÇ©ÇÁ
			if( teigi_no >= MAX_TEIGI_NO ) continue;
			if( teigi_no > fdata_p->pair_teigi_end ) continue;	// '}' Ç‹Ç≈

			cnt++;
			if( teigi_ofset == 0 )
			{
				end_pos = fdata_p->top_pos[teigi_no - 1] + pos_map[teigi_ofset];
//				if( end_pos == 0 ) end_pos = 3; // '{'Ç™topà íuÇÃèÍçáÇÃï‚ê≥
			}
			else end_pos = total_pos[teigi_ofset - 1] + pos_map[teigi_ofset];

			if( fdata_p->status[teigi_no] & ST_TAB )
			{ // form_big_kakko_pair : '{'Å`'}'ÇÃèàóù 0:ΩÕﬂ∞ΩÇÃÇ›, 1:ç∂ë§Ç…ëµÇ¶ÇÈ(ç≈è¨TAB=1), 2:é©ìÆÇ≈TABçÏê¨(ΩÕﬂ∞Ω+TABÇ≈çáÇÌÇπÇÈ)
				if( form_big_kakko_pair == 0 ) end_pos++;									// ΩÕﬂ∞ΩÇÃÇ›
				else if( form_big_kakko_pair == 1 ) end_pos = ( (end_pos + 4) / 4 ) * 4;	// mode = 0,TABÇ≈çáÇÌÇπÇÈ
				else end_pos++; // ΩÕﬂ∞ΩÇÃÇ› form_big_kakko_pair = 3

				if( form_limit_line && end_pos > (form_limit_line * 4) )
				{
					for( n = fdata_p->pair_teigi_top + 1; n < MAX_TEIGI_NO; n++ )
					{ // '{' ÇÃéüÇ©ÇÁ
						if( fdata_p->status[n] ) fdata_p->status[n] &= ~( ST_TAB ); // reset
						else break;
					}
					return( 1 ); // over
				}
			}
			else end_pos++;																// ΩÕﬂ∞Ω1å¬ï™

			if( end_pos < 4 ) end_pos = fdata_p->top_pos[teigi_no];						// ï‚ê≥
			if( end_pos < 4 ) end_pos = 4;
			if( total_pos[teigi_ofset] < end_pos ) total_pos[teigi_ofset] = end_pos;	// ëÂÇ´Ç¢à íuÇæØƒ
		}
		if( cnt == 0 || mode == 0 ) break;
	}
	return( 0 );
}
// ---------------------------------------------------------------------
// "{Å`}"ÇÃèàóù ìØÇ∂íËêîÇÃêî
// mode = 0:'{'ÇæÇØÇ†ÇÌÇπÇÈ, 1:'{'à»å„ÇÇ†ÇÌÇπÇÈ
// ---------------------------------------------------------------------
void pair_kakko_parts( int mode, int line_start, int line_last )
{
	struct	FDATA *fdata_p;
	int		teigi_no, tmp_line, len;
	int		top_pos, end_pos, max_pos;
	int		teigi_ofset;
	char	buf[CHAR_SIZE];

	while( chk_teigi_tab_max(mode, line_start, line_last) ); // TABóLå¯Ç»ècÇÃç≈ëÂílÇí≤Ç◊ÇÈ

	// ----------- "{}"ä‘ÇÕTABóLå¯, '{'Å` TAB,ΩÕﬂ∞ΩÇ≈ëµÇ¶ÇÈ ---------------
	for( teigi_ofset = mode; teigi_ofset < MAX_TEIGI_NO; teigi_ofset++ )
	{ // '{'Ç©ÇÁëµÇ¶ÇÈà◊pair_teigi_top Ç©ÇÁ
		// ------ ëµÇ¶ÇÈ -------------
		for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
		{
			fdata_p = &ope_buf[tmp_line];

#ifdef _DEBUG
			if( tmp_line == 234 )
			{

				debug_n = 0;
			}
#endif
			teigi_no = fdata_p->pair_teigi_top + teigi_ofset;
			if( teigi_no >= MAX_TEIGI_NO ) continue;
			if( teigi_no > fdata_p->pair_teigi_end ) continue; // '}'ÇÕ ﬂΩ
			if( fdata_p->pair_teigi_top == 0 ) continue;
			if( fdata_p->line_type == T_CALL || fdata_p->line_type == T_PROC ) continue;

			if( fdata_p->status[teigi_no] & (ST_SPACE | ST_TAB) )
			{ // TABÅAΩÕﬂ∞ΩóLå¯
				max_pos = total_pos[teigi_ofset];

				end_pos = fdata_p->top_pos[teigi_no - 1] + fdata_p->block_len[teigi_no - 1];	// mes pos.
				memcpy( buf, fdata_p->mes, end_pos );
				buf[end_pos] = 0;

				end_pos = arrange_tab_soh( max_pos, end_pos, buf );								// TABí≤êÆ

				top_pos = fdata_p->top_pos[teigi_no];
				strcpy( &buf[end_pos], &fdata_p->mes[top_pos] );								// écÇËcopy
				strcpy( fdata_p->mes, buf );													// ñﬂÇ∑
				len = end_pos - top_pos;

				while( teigi_no < MAX_TEIGI_NO )
				{
					top_pos = fdata_p->top_pos[teigi_no];
					if( top_pos == 0 && teigi_no >= 2 ) break; // éüÇ™Ç»Ç¢
					fdata_p->top_pos[teigi_no] += len;
					teigi_no++;
				}
			}
		}
		if( mode == 0 ) break;
	}
}
// ---------------------------------------------------------------------
// "{Å`}"ÇÃèàóù
// ìríÜÇ≈í∑Ç∑Ç¨ÇÈèÍçáÇ™Ç†ÇÈÇÃÇ≈åüç∏ÇÃÇ›ÇÃ”∞ƒﬁÇê›ÇØÇÈ
// ---------------------------------------------------------------------
void pair_kakko_arrange( int base_type, int line_start, int line_last )
{
	struct	FDATA *fdata_p;
	int		cnt, tmp_line;

	#define DEBUG_LINE	232

#ifdef _DEBUG
	if( line_start >= DEBUG_LINE )
	{
		debug_n = 0;
	}
#endif
//	if( !(base_type == G_TYPE1 || base_type == G_TYPE2 || base_type == G_TYPE_IN || base_type == G_B_K_PAIR) ) return;

	// ---------------- ç≈ëÂí∑Ç≥Çí≤Ç◊ÇÈ -------------
	cnt = 0;
	for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
	{
		fdata_p = &ope_buf[tmp_line];
		if( fdata_p->pair_teigi_top == 0 ) continue;

		if( cnt == 0 ) cnt = fdata_p->pair_teigi_end - fdata_p->pair_teigi_top; // len
		else if( (fdata_p->pair_teigi_end - fdata_p->pair_teigi_top) != cnt )
		{ // íËêîÇÃêîà·Ç¢
			pair_kakko_parts( 1, line_start, tmp_line );
			line_start = tmp_line;										// set new
			cnt = fdata_p->pair_teigi_end - fdata_p->pair_teigi_top;	// len
		}
	}
	if( line_start < line_last ) pair_kakko_parts( 1, line_start, line_last );
}
// ---------------------------------------------------------------------
// teigi_no = 0:∫“›ƒï‚èï + tab_pos ÇÃèàóù
// ---------------------------------------------------------------------
void teigi_zero_syori( int line_start, int line_last )
{
	struct	FDATA *fdata_p;
	int		tmp_line, end_pos, max_pos;
	char	buf[CHAR_SIZE];

	for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
	{
		fdata_p = &ope_buf[tmp_line];
		if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ
		if( fdata_p->line_type & T_MASK_MES ) continue;

#ifdef _DEBUG
		if( tmp_line >= 22 )
		{
			debug_n = 0;
		}
#endif

		max_pos = fdata_p->tab_pos * 4;
		cut_last_space( 1, fdata_p->pri_comment ); // ç≈å„ÇÃTAB,spaceÇçÌèú
		end_pos = strlen( fdata_p->pri_comment );
		fdata_p->block_len[0] = end_pos;
		if( end_pos == 0 )
		{ // Ç»Çµ
			fdata_p->status[0] = ST_SPACE;
		}
		else {
			memcpy( buf, fdata_p->pri_comment, end_pos ); // top∫“›ƒÇcopy
			fdata_p->status[0] = ST_SPACE | ST_TAB;
		}
		buf[end_pos] = 0;

		if( (fdata_p->hojo_flag & H_MES15) == 0 )
		{
			if( (max_pos - end_pos) > 0 ) end_pos = arrange_tab_soh( max_pos, end_pos, buf );
		}

		if( end_pos )
		{
			if( buf[end_pos - 1] != _SOH && buf[end_pos - 1] != ' ' &&
				fdata_p->mes[0] != _SOH && fdata_p->mes[0] != ' ' ) buf[end_pos++] = ' ';
			strcpy( &buf[end_pos], fdata_p->mes );	// ñ{ï∂Çcopy
			strcpy( fdata_p->mes, buf );			// ñ{ï∂ÇñﬂÇ∑
		}
//		fdata_p->story_last_pos = end_pos;	// ñ{ï∂ÇÃç≈å„ÇæØƒ(èôÅXÇ…çXêVÇ∑ÇÈ)
		fdata_p->top_pos[1] = end_pos;		// éüÇÃtop
		fdata_p->block_len[1] = 0;
		fdata_p->pair_teigi_top = 0;
		fdata_p->pri_comment[0] = 0;		// clear
	}
}
// ---------------------------------------------------------------------
// GASM èàóù
// ---------------------------------------------------------------------
void g_asm_syori( int base_type, int line_start, int line_last )
{
	struct	FDATA *fdata_p;
	int		pos, top_pos, end_pos, teigi_no, last_teigi_no, tmp_line;
	int		tok_len, max_pos, least_pos;
	int		comment_cnt;
	char	tok_buf[CHAR_SIZE];

	// ------------ ïœêîÇÃç≈ëÂí∑ÇåvéZÇ∑ÇÈ ---------------
	for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
	{
		fdata_p = &ope_buf[tmp_line];
		if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ

//		fdata_p->status[1] = ST_SPACE | ST_TAB;
		fdata_p->status[1] = ST_SPACE;
		fdata_p->status[2] = 0;
	}

	// ----------------- äeãÊêÿÇËà íuÇåàÇﬂÇÈ --------------------
	comment_cnt = 0; // ç≈ëÂíl
	teigi_zero_syori( line_start, line_last );
	for( teigi_no = 1; teigi_no < MAX_TEIGI_NO; teigi_no++ )
	{ // 0:offsetïî, 1:íËã`, 2:íËêî1, 3:íËêî2, ...
		last_teigi_no = 0;
		least_pos = max_pos = 0;
		memset( total_pos, 0, sizeof(total_pos) );

		for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
		{
			fdata_p = &ope_buf[tmp_line];
			if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ
			if( fdata_p->line_type & T_MASK_MES ) continue;
//			if( fdata_p->hojo_flag & H_YEN2 ) continue;

#ifdef _DEBUG
			if( tmp_line >= 4150 && teigi_no >= 0 )
			{
				debug_n = fdata_p->mes[0];
			}
#endif
			if( teigi_no == 1 || fdata_p->top_pos[teigi_no] )
			{
				top_pos = end_pos = fdata_p->top_pos[teigi_no];
				if( fdata_p->hojo_flag & H_YEN2 )
					end_pos += get_tok3( tok_buf, &fdata_p->mes[end_pos], &tok_len );	// Ãﬁ€Ø∏ÇÃêÿÇËèoÇµ("//"ÇÕ1Ãﬁ€Ø∏)
				else end_pos += get_tok2( tok_buf, &fdata_p->mes[end_pos], &tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›

				if( tok_len )
				{
#ifdef _DEBUG
					if( tmp_line >= 127 && teigi_no >= 0 )
					{
						debug_n = fdata_p->mes[0];
					}
#endif
					fdata_p->status[teigi_no] |= ST_SPACE;									// óLå¯
					fdata_p->block_len[teigi_no] = end_pos - fdata_p->top_pos[teigi_no];	// é¿ í∑Ç≥
					if( cur_moji_type == C_COM1 || cur_moji_type == C_SEMIKOLON )
					{ // ∫“›ƒî≠å©ÅBTABã÷é~ÇÕÇ±Ç±Ç≈èàóùÇ∑ÇÈ
						pos = fdata_p->top_pos[teigi_no - 1] + fdata_p->block_len[teigi_no - 1];
						fdata_p->status[teigi_no] |= ST_COM; // comment
						fdata_p->com_teigi_no = teigi_no;
						comment_cnt++;
					}
					else { // ----------------- ø∞ΩÇÃTABà íuÇí≤Ç◊ÇÈ --------------------
						if( end_pos < MAX_END_MAP )
						{
							if( fdata_p->status[teigi_no] & ST_TAB )
							{ // óLå¯
								if( end_pos > max_pos ) max_pos = end_pos;			// ëÂÇ´Ç¢ï˚Çset
								if( least_pos == 0 ) least_pos = end_pos;			// èââÒ
								else if( end_pos < least_pos ) least_pos = end_pos; // è¨Ç≥Ç¢ï˚Çset
								total_pos[end_pos] += 1;
							}
						}
					}
				}
				else { // à»å„Ç»Çµ
					fdata_p->status[teigi_no] = 0;		// Ç»Çµ
					fdata_p->top_pos[teigi_no] = 0;		// Ç»Çµ
					fdata_p->block_len[teigi_no] = 0;	// é¿ í∑Ç≥
				}
			}
		}

		if( teigi_no == 1 ) max_pos = ( (max_pos + 4) / 4 ) * 4; // posà íuÇÃåvéZ
		else max_pos = 0;
		// ----------------- TABà íuÇçáÇÌÇπÇÈ --------------------
		if( set_tab(teigi_no, line_start, line_last, max_pos) == 0 ) break;
	}
	if( comment_cnt == 0 ) return; // ∫“›ƒÇ»Çµ

	// ------------ ∫“›ƒ ÇÃTABÇàÍíU óLå¯Ç…Ç∑ÇÈ -------------
//	for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
//	{
//		fdata_p = &ope_buf[tmp_line];
//		teigi_no = fdata_p->com_teigi_no;
//		if( teigi_no == 0 ) continue; // ∫“›ƒÇ»Çµ

//		if( teigi_no > 0 && teigi_no < MAX_END_MAP ) fdata_p->status[teigi_no] |= ST_TAB;	// TABóLå¯
//		else fdata_p->status[teigi_no] &= ~( ST_TAB );										// TABñ≥å¯
//	}
	// ------------ ∫“›ƒ ÇÃèàóù TABà íuÇ™Ç∏ÇÍÇÈà◊,ï°êîâÒçsÇ§ -------------
	while( line_start < line_last )
	{
		comment_syori( base_type, &line_start, line_last );
	}
}
// ---------------------------------------------------------------------
// ìØóﬁÇÃòAë±ÇTABÇ≈ÇªÇÎÇ¶ÇÈ
// ìríÜÇ≈ãÊêÿÇ¡ÇΩÇŸÇ§Ç™ÇÊÇ¢èÍçáÇÕ,ÇªÇÃçsÇï‘Ç∑
// return( line_last )
// ---------------------------------------------------------------------
void ajust_tab( int base_type, int line_start, int line_last )
{
	struct	FDATA *fdata_p;
	int		pos, top_pos, end_pos, teigi_no, last_teigi_no, tmp_line, bunpu_cnt;
	int		tok_len, max_pos, least_pos, type_back_pos;
	int		back_end_pos, back_cur_moji_type, back_tok_len, struct_cnt;
	int		comment_cnt, n, flag, sub_type;
	char	tok_buf[CHAR_SIZE];

	// ------------ ïœêîÇÃç≈ëÂí∑ÇåvéZÇ∑ÇÈ ---------------
	struct_cnt = 0; // structÇÃêî
	for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
	{
		fdata_p = &ope_buf[tmp_line];
		if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ

#ifdef _DEBUG
		if( tmp_line >= 4150 )
		{
			debug_n = fdata_p->tab_pos;
		}
#endif
		switch( base_type )
		{
		case G_TYPE1:
//		case G_EXTERN:
		case G_DEF_OTHER:
		case G_TYPEDEF:
		case G_STRUCT1: // struct
		case G_STRUCT2: // stryct {}
		case G_TYPE_IN:
			if( (fdata_p->hojo_flag & (H_BIG_K_L | H_BIG_K_R)) == H_BIG_K_L ||
				(fdata_p->hojo_flag & (H_BIG_K_L | H_BIG_K_R)) == H_BIG_K_R ) fdata_p->status[1] = 0;
			else if( fdata_p->line_type == T_STRUCT_IN || fdata_p->line_type == T_UNION_IN )
			{
				if( fdata_p->hojo_flag & H_B_K_PAIR ) fdata_p->status[1] = 0;
				else if( (tmp_line + 1) < line_last && ope_buf[tmp_line + 1].line_type == T_BIG_KAKKO &&
					(ope_buf[tmp_line + 1].hojo_flag & H_BIG_K_L) ) fdata_p->status[1] = 0;
				else {
					fdata_p->status[1] = ST_SPACE | ST_TAB;
					struct_cnt++; // structÇÃêî
				}
			}
			else fdata_p->status[1] = ST_SPACE | ST_TAB;
			fdata_p->status[2] = 0;
			fdata_p->status[3] = 0;
			fdata_p->status[4] = 0;
			break;

		case G_TYPE2: // + {}
			fdata_p->status[1] = ST_SPACE | ST_TAB;
			fdata_p->status[2] = 0;
			fdata_p->status[3] = 0;
			fdata_p->status[4] = 0;
			break;

		case G_B_K_PAIR:
			fdata_p->status[1] = 0;
			fdata_p->status[2] = ST_SPACE | ST_TAB;
			fdata_p->status[3] = ST_SPACE | ST_TAB;
			fdata_p->status[4] = ST_SPACE | ST_TAB;
			break;

		case G_DIGIT:
			fdata_p->status[1] = ST_SPACE | ST_TAB;
			fdata_p->status[2] = ST_SPACE | ST_TAB;
			fdata_p->status[3] = ST_SPACE | ST_TAB;
			fdata_p->status[4] = ST_SPACE | ST_TAB;
			break;

		case G_MOJIS:
			fdata_p->status[1] = 0;
			fdata_p->status[2] = 0;
			fdata_p->status[3] = 0;
			fdata_p->status[4] = 0;
			break;

		case G_DEFINE:
			fdata_p->status[1] = ST_SPACE | ST_TAB;
			fdata_p->status[2] = ST_SPACE | ST_TAB;
			fdata_p->status[3] = 0;
			fdata_p->status[4] = 0;
			break;

//		case G_ASM: // ï™ó£ÇµÇΩ
//			fdata_p->status[1] = ST_SPACE | ST_TAB;
//			fdata_p->status[2] = 0;
//			fdata_p->status[3] = 0;
//			fdata_p->status[4] = 0;
//			break;

		default:
//		case G_IF:
//		case G_INCLUDE:
//		case G_OTHER:
//		case G_PROC:
			fdata_p->status[1] = 0;
			fdata_p->status[2] = 0;
			fdata_p->status[3] = 0;
			fdata_p->status[4] = 0;
			break;
		}
	}
	if( struct_cnt >= 2 )
	{ // ï°êîÇÃstructÇÃèÍçáÇÕëµÇ¶ÇÈ
		for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
		{
			fdata_p = &ope_buf[tmp_line];
			if( fdata_p->line_type == T_STRUCT_IN &&
				(fdata_p->hojo_flag & (H_BIG_K_L | H_BIG_K_R)) == 0 ) fdata_p->status[2] = ST_SPACE | ST_TAB;
//			if( fdata_p->line_type == T_STRUCT_IN )
//			{
//				if( ((tmp_line + 1) < line_last && ope_buf[tmp_line + 1].line_type != T_BIG_KAKKO) &&
//					(fdata_p->hojo_flag & (H_BIG_K_L | H_BIG_K_R)) == 0 ) fdata_p->status[2] = ST_SPACE | ST_TAB;
//			}
		}
	}
	// ----------------- äeãÊêÿÇËà íuÇåàÇﬂÇÈ --------------------
	comment_cnt = 0;
	teigi_zero_syori( line_start, line_last );
	for( teigi_no = 1; teigi_no < MAX_TEIGI_NO; teigi_no++ )
	{ // 0:offsetïî, 1:íËã`, 2:íËêî1, 3:íËêî2, ...
		last_teigi_no = 0;
		bunpu_cnt = 0;
		end_pos = least_pos = max_pos = 0; // zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
		memset( total_pos, 0, sizeof(total_pos) );

		for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
		{
			fdata_p = &ope_buf[tmp_line];
			if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ
			if( fdata_p->line_type & T_MASK_MES ) continue;
//			if( fdata_p->hojo_flag & H_YEN2 ) continue;

#ifdef _DEBUG
			if( tmp_line >= 7817 )
			{
				debug_n = fdata_p->mes[0];
			}
#endif
			if( teigi_no == 1 )
			{
//				if( fdata_p->hojo_flag & (H_MES14 | H_MES15 | H_MES_E) ) comment_cnt++;
				fdata_p->big_kakko_cnt = 0;
			}

			if( teigi_no == 1 || fdata_p->top_pos[teigi_no] )
			{
				top_pos = end_pos = fdata_p->top_pos[teigi_no];
				if( teigi_no > 4 ) fdata_p->status[teigi_no] |= fdata_p->status[4] & ( ST_SPACE | ST_TAB ); // à»å„ìØÇ∂Ç…Ç∑ÇÈ

				if( chk_tab_enable(tmp_line) == G_OTHER ) fdata_p->status[teigi_no] = ST_SPACE;				// TABã÷é~

				if( fdata_p->line_type == T_DEFINE )
				{
					if( teigi_no == 1 )
						end_pos += get_tok2( tok_buf, &fdata_p->mes[end_pos], &tok_len );		// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
					else if( teigi_no == 2 )
						end_pos += get_define_no2( tok_buf, &fdata_p->mes[end_pos], &tok_len ); // #defineÇÃãÊêÿÇËÇìæÇÈ
//					else if( form_define_tab == 0 || teigi_no >= 3 )
					else
						end_pos += get_tok3( tok_buf, &fdata_p->mes[end_pos], &tok_len );		// Ãﬁ€Ø∏ÇÃêÿÇËèoÇµ("//"ÇÕ1Ãﬁ€Ø∏)
				}
				else if( fdata_p->hojo_flag & H_YEN2 )
					end_pos += get_tok3( tok_buf, &fdata_p->mes[end_pos], &tok_len ); // Ãﬁ€Ø∏ÇÃêÿÇËèoÇµ("//"ÇÕ1Ãﬁ€Ø∏)
				else if( fdata_p->line_type == T_DEFIF )
				{
					end_pos += get_tok2( tok_buf, &fdata_p->mes[end_pos], &tok_len ); // ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
				}
				else {
					type_back_pos = end_pos; // TYPE_MASKóp
					if( fdata_p->status[teigi_no] & (ST_PAIR_R | ST_PAIR_IN) )
					{ // "{Å`}"ÇÃÉRÉsÅ[ÅB∫›œíPà Ç≈ãÊêÿÇÈ. cur_moji_type = C_KOMMA, C_COM1, C_BIG_K_L, C_BIG_K_R
						end_pos += get_tok4( tok_buf, &fdata_p->mes[end_pos], &tok_len );
					}
					else end_pos += get_tok2( tok_buf, &fdata_p->mes[end_pos], &tok_len ); // ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
					if( cur_moji_type == C_BIG_K_L )
					{
						if( fdata_p->hojo_flag & H_B_K_PAIR )
						{
							if( chk_big_kakko(&fdata_p->mes[top_pos], &pos) <= 0 )
							{
								if( fdata_p->pair_teigi_top )
								{ // ï°êîÇ†ÇÈ
									fdata_p->hojo_flag &= ~( H_B_K_PAIR ); // ï°êîÇÃÕﬂ±∞äáå ÇÕ,reset
									for( pos = fdata_p->pair_teigi_top; pos <= teigi_no; pos++ )
									{
										fdata_p->status[pos] &= ~( ST_PAIR_L | ST_PAIR_R | ST_PAIR_IN ); // reset "{Å`}"
									}
									fdata_p->pair_teigi_top = 0;
									fdata_p->big_kakko_cnt = 0;
								}
								else { // êVãKìoò^
									fdata_p->status[teigi_no] |= ST_PAIR_L; // "{Å`}"ÇÃäJénà íu
									fdata_p->pair_teigi_top = teigi_no;
									fdata_p->pair_teigi_end = 0;			// reset
									fdata_p->big_kakko_cnt++;
								}
							}
						}
						else for( n = teigi_no; n < MAX_END_MAP; n++ )
						{
							if( fdata_p->status[n] == 0 ) break;
							fdata_p->status[n] &= ~( ST_TAB );
						}
						end_pos += add_comment( &fdata_p->mes[end_pos] ); // "{"+∫“›ƒÇ»ÇÁÇPÇ¬Ç…Ç∑ÇÈ
					}
					else if( cur_moji_type == C_BIG_K_R )
					{
						if( (fdata_p->hojo_flag & H_B_K_PAIR) && fdata_p->pair_teigi_end == 0 )
						{
							if( --fdata_p->big_kakko_cnt == 0 )
							{ // ãÊêÿÇËà íu
								if( (fdata_p->pair_teigi_top + 1) == teigi_no )
								{ // "{}"
									fdata_p->hojo_flag &= ~( H_B_K_PAIR ); // ï°êîÇÃÕﬂ±∞äáå ÇÕ,reset
									for( pos = fdata_p->pair_teigi_top; pos <= teigi_no; pos++ )
									{
										fdata_p->status[pos] &= ~( ST_PAIR_L | ST_PAIR_R | ST_PAIR_IN ); // reset "{Å`}"
									}
									fdata_p->pair_teigi_top = 0;
									fdata_p->big_kakko_cnt = 0;
								}
								else {
									fdata_p->status[teigi_no] |= ST_PAIR_R;
									fdata_p->pair_teigi_end = teigi_no;
								}
							}
						}
						else for( n = teigi_no; n < MAX_END_MAP; n++ )
						{
							if( fdata_p->status[n] == 0 ) break;
							fdata_p->status[n] &= ~( ST_TAB );
						}
//						end_pos += add_comment( &fdata_p->mes[end_pos] ); // "{"+∫“›ƒÇ»ÇÁÇPÇ¬Ç…Ç∑ÇÈ
					}

					if( teigi_no == 1 )
					{
#ifdef _DEBUG
						if( tmp_line >= 96 )
						{
							debug_n = fdata_p->mes[0];
						}
#endif
						if( fdata_p->line_type == T_TYPEDEF )
						{
							back_end_pos = end_pos;													// ëﬁî
							end_pos += kaiseki_typedef( &fdata_p->mes[end_pos] );					// #typedef ÇÃâêÕ
							if( back_end_pos == end_pos ) fdata_p->status[teigi_no] &= ~( ST_TAB ); // tab ã÷é~
						}
						else {
							if( cur_moji_type == C_KOMMA || cur_moji_type == C_KOLON || cur_moji_type == C_WKOLON )
							{
								back_end_pos = end_pos;												// ëﬁî
								back_cur_moji_type = cur_moji_type;									// ëﬁî
								back_tok_len = tok_len;
								end_pos += get_tok2( tok_buf, &fdata_p->mes[end_pos], &tok_len );	// ãÊêÿÇËà íuÇ‹Ç≈écÇËéÊÇËçûÇ›
								if( cur_moji_type == C_COM1 || cur_moji_type == 0 )
								{ // ñﬂÇ∑
									end_pos = back_end_pos;
									cur_moji_type = back_cur_moji_type;
									tok_len = back_tok_len;
								}
								else type_back_pos = back_end_pos;
							}

							if( cur_moji_type == C_OTHER )
							{
								if( fdata_p->line_type & (T_TYPE | T_MASK_IN | T_STRUCT | T_UNION) )
								{
									// Ç±Ç±Çç≈å„Ç…åüç∏ÅBMASK_TYPEÇÇPÇ¬Ç…Ç∑ÇÈ
									type_back_pos += add_bind_type2( tmp_line, &fdata_p->mes[type_back_pos] );
									if( end_pos < type_back_pos ) end_pos = type_back_pos;
								}
							}
							else if( cur_moji_type == C_STRUCT || cur_moji_type == C_UNION )
								end_pos += add_b_k_l( &fdata_p->mes[end_pos] ); // struct/union+'{'Ç»ÇÁÇPÇ¬Ç…Ç∑ÇÈ
							else if( cur_moji_type & (C_MASK_TYPE1 | C_MASK_TYPE2) )
							{
								// Ç±Ç±Çç≈å„Ç…åüç∏ÅBï°êîÇÃMASK_TYPEÇÇPÇ¬Ç…Ç∑ÇÈ
								type_back_pos += add_bind_type2( tmp_line, &fdata_p->mes[type_back_pos] );
								if( end_pos < type_back_pos ) end_pos = type_back_pos;
							}
						}
					}
				}
				if( tok_len )
				{
#ifdef _DEBUG
					if( tmp_line >= 4150 && teigi_no >= 1 )
					{
						debug_n = fdata_p->mes[0];
					}
#endif
					fdata_p->status[teigi_no] |= ST_SPACE;											// óLå¯
					if( fdata_p->line_type == T_DEFIF ) fdata_p->status[teigi_no] &= ~( ST_TAB );	// ã÷é~
					fdata_p->block_len[teigi_no] = end_pos - fdata_p->top_pos[teigi_no];			// é¿ í∑Ç≥
					if( cur_moji_type == C_COM1 )
					{ // ∫“›ƒî≠å©ÅBTABã÷é~ÇÕÇ±Ç±Ç≈èàóùÇ∑ÇÈ
						pos = fdata_p->top_pos[teigi_no - 1] + fdata_p->block_len[teigi_no - 1];
						fdata_p->status[teigi_no] |= ST_COM; // comment
						fdata_p->com_teigi_no = teigi_no;
						comment_cnt++;
					}
					else { // ----------------- ø∞ΩÇÃTABà íuÇí≤Ç◊ÇÈ --------------------
						if( end_pos < MAX_END_MAP )
						{
							if( (fdata_p->status[teigi_no] & (ST_PAIR_L | ST_PAIR_R | ST_PAIR_IN)) &&
								fdata_p->pair_teigi_end == 0 )
							{
								fdata_p->status[teigi_no + 1] |= ST_PAIR_IN; // à»å„set
							}
							if( (fdata_p->status[teigi_no] & (ST_PAIR_R | ST_PAIR_IN)) == 0 )
							{ // --------- Õﬂ±∞äáå  "{Å`}"ì‡Ç≈ÇÕÇ»Ç¢ ---------------------
								if( fdata_p->status[teigi_no] & ST_TAB )
								{ // óLå¯
									if( end_pos > max_pos ) max_pos = end_pos;			// ëÂÇ´Ç¢ï˚Çset
									if( least_pos == 0 ) least_pos = end_pos;			// èââÒ
									else if( end_pos < least_pos ) least_pos = end_pos; // è¨Ç≥Ç¢ï˚Çset
									total_pos[end_pos] += 1;
									bunpu_cnt++;
								}
							}
						}
						else fdata_p->status[teigi_no] &= ~( ST_TAB ); // TABñ≥å¯
					}
				}
				else { // à»å„Ç»Çµ
					fdata_p->status[teigi_no] = 0;		// Ç»Çµ
					fdata_p->top_pos[teigi_no] = 0;		// Ç»Çµ
					fdata_p->block_len[teigi_no] = 0;	// é¿ í∑Ç≥
				}
			}
		}
//		if( teigi_no >= 2 && (base_type & (G_DEFINE | G_DEF_OTHER | G_TYPEDEF)) == 0 )
		if( (base_type & (G_DEFINE | G_DEF_OTHER | G_TYPEDEF)) == 0 )
		{
			if( bunpu_cnt == 1 || max_pos == least_pos ) max_pos = 0; // ìØÇ∂ècà íuÇÃòAë± ' 'ÇÃÇ›
		}
		if( base_type == G_DEFINE )
		{
			max_pos = ( (max_pos + 4) / 4 ) * 4;			// ç≈í·1TABà»è„ãÛÇØÇÈ
			if( (max_pos - least_pos) < 2 ) max_pos += 4;	// ç≈í·2ΩÕﬂ∞Ωà»è„ãÛÇØÇÈ
		}
		else if( base_type == G_DIGIT ) max_pos++;
		else max_pos = ( (max_pos + 4) / 4 ) * 4; // posà íuÇÃåvéZ

		if( teigi_no == 1 )
		{
			switch( base_type )
			{
//			case G_EXTERN:
			case G_DEF_OTHER:
			case G_TYPEDEF:
			case G_TYPE1:
			case G_TYPE2:
//			case G_OTHER_TYPE:
				if( form_global_int_tab > 0 && form_global_int_tab != 2 &&
					max_pos > (form_global_int_tab * 4) ) max_pos = form_global_int_tab * 4;
				break;

			case G_DEFINE:
				max_pos = 0; // space only
				break;

			case G_TYPE_IN:
				if( form_local_int_tab > 0 && form_local_int_tab != 2 &&
					max_pos > (form_local_int_tab * 4) ) max_pos = form_local_int_tab * 4;
				break;

//			case G_STRUCT1:
//			case G_STRUCT2:
//			case G_B_K_PAIR:
//			case G_IF:
//			case G_OTHER:
//			case G_INCLUDE:
//			case G_DEFIF:
//			case G_DIGIT:
//			case G_CASE:
//				break;
			}
		}
		else if( teigi_no == 2 && base_type == G_DEFINE )
		{
			if( form_define_tab == 1 ) max_pos = 0; // ΩÕﬂ∞ΩÇÃÇ›
			else if( form_define_tab >= 3 )
			{
				if( max_pos < (form_define_tab * 4) ) max_pos = form_define_tab * 4;
			}
		}
		// ----------------- TABà íuÇçáÇÌÇπÇÈ --------------------
		if( set_tab(teigi_no, line_start, line_last, max_pos) == 0 ) break;
	}
	// --------------- '{'ÇÇªÇÎÇ¶ÇÈ -----------------------
	pair_kakko_parts( 0, line_start, line_last );

	if( base_type == G_TYPE1 || base_type == G_TYPE2 )
	{
		flag = 0;
		for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
		{
			fdata_p = &ope_buf[tmp_line];
			if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ
#ifdef _DEBUG
			if( tmp_line >= 64 )
			{
				debug_n = (int)fdata_p->mes;
			}
#endif
			if( flag == 0 )
			{ // èââÒ
				n = tmp_line;
				if( (fdata_p->hojo_flag & H_BIG_K_L) && fdata_p->sub_type )
				{ // typeÇ≈ëµÇ¶ÇÈ
					sub_type = fdata_p->sub_type;
					flag = 2;
				}
				else { // ÇΩÇæëµÇ¶ÇÈ
					sub_type = 0;
					flag = 1;
				}
			}
			else if( flag == 1 )
			{ // ÇΩÇæëµÇ¶ÇÈ
				if( (fdata_p->hojo_flag & H_BIG_K_L) && fdata_p->sub_type )
				{ // ïœâª
					pair_kakko_arrange( base_type, n, tmp_line );	// "{Å`}"ÇÃèàóù
					n = tmp_line;									// set new
					sub_type = fdata_p->sub_type;
					flag = 2;
				}
			}
			else if( flag == 2 )
			{ // typeÇ≈ëµÇ¶ÇÈ
				if( !((fdata_p->hojo_flag & H_BIG_K_L) && sub_type == fdata_p->sub_type) )
				{ // ïœâªÇ†ÇË
					pair_kakko_arrange( base_type, n, tmp_line );	// "{Å`}"ÇÃèàóù
					n = tmp_line;									// set new
					if( fdata_p->hojo_flag & H_BIG_K_L )
					{ // typeÇ≈ëµÇ¶ÇÈ
						sub_type = fdata_p->sub_type;
						flag = 2;
					}
					else { // ÇΩÇæëµÇ¶ÇÈ
						sub_type = 0;
						flag = 1;
					}
				}
			}
		}
		if( n < line_last ) pair_kakko_arrange( base_type, n, line_last ); // écÇËèàóùÅB"{Å`}"ÇÃèàóù
	}
	else pair_kakko_arrange( base_type, line_start, line_last );	// "{Å`}"ÇÃèàóù

	if( comment_cnt == 0 ) return;									// ∫“›ƒÇ»Çµ

	// ------------ ∫“›ƒ ÇÃTABÇàÍíU óLå¯Ç…Ç∑ÇÈ -------------
//	for( tmp_line = line_start; tmp_line < line_last; tmp_line++ )
//	{
//		fdata_p = &ope_buf[tmp_line];
//		teigi_no = fdata_p->com_teigi_no;
//		if( teigi_no == 0 ) continue;					// ∫“›ƒÇ»Çµ

//		if( teigi_no > 0 && teigi_no < MAX_END_MAP )
//			fdata_p->status[teigi_no] |= ST_TAB;		// TABóLå¯
//		else fdata_p->status[teigi_no] &= ~( ST_TAB );	// TABñ≥å¯
//	}
	// ------------ ∫“›ƒ ÇÃèàóù TABà íuÇ™Ç∏ÇÍÇÈà◊,ï°êîâÒçsÇ§ -------------
	while( line_start < line_last )
	{
		comment_syori( base_type, &line_start, line_last );
	}
}
// ---------------------------------------------------------------------
// ìØóﬁÇÃòAë±ÇTABÇ≈ÇªÇÎÇ¶ÇÈ
// Ãß≤ŸÇ…èoóÕ
// return 0:ïœçXÇ»Çµ, -1:ïœçXâ”èäëΩÇ∑Ç¨, >0:ïœçXçsêî
// ---------------------------------------------------------------------
int save_dst_file( void )
{
	FILE	*fp_dst, *fp_dbg;
	string	srcSJIS_out;
	struct	FDATA *fdata_p;
	int		len, line_no, line_last, base_type, crlf_cnt, com_pos, cur_type, syori_cnt, n;
	int		tmp_type;
	char	dbg_buf[CHAR_SIZE2], buf[CHAR_SIZE2];

	strcpy( tmp_name, "renew_tmp.tmp" );
	fp_dst = fopen( tmp_name, "wb" ); // çÌèú
	if( fp_dst == NULL )
	{
		printf( "Fatal: can't open file:%s\n", new_name );
		wait_exit( 1 );
	}

	if( debug_mode )
	{
		fp_dbg = fopen( debug_name2, "wb" ); // çÌèú
		if( fp_dbg == NULL )
		{
			printf( "Fatal: can't open file:%s\n", debug_name2 );
			wait_exit( 1 );
		}
	}
	else fp_dbg = NULL;

	// ---------------- ëOçsÇÃ∫“›ƒÇ…çáÇÌÇπÇÈÇ©ÇÃà íuí≤êÆ -------------------
	com_pos = 0;
	for( line_no = 0; line_no < max_line; line_no++ )
	{
		fdata_p = &ope_buf[line_no];

		if( fdata_p->line_type == T_CRLF ) continue; // â¸çsÇÃÇ›ÇÕ ﬂΩ

#ifdef _DEBUG
		if( line_no >= 77 )
		{
			debug_n = (int)fdata_p->mes;
		}
#endif
		open_tab_mes( line_no ); // pri_comment, tab_posÇìWäJÇ∑ÇÈ
		if( (fdata_p->line_type == T_MES15) && com_pos && com_pos <= fdata_p->src_com_pos )
		{ // ∫“›ƒÇÃÇ›ÇÃTABÇÕ,ëOçsÇÃ∫“›ƒÇÃTABÇ∆çáÇÌÇπÇÈ
			fdata_p->src_com_pos = com_pos;
			fdata_p->hojo_flag |= H_MES_E;
			// ---------- change ---------------
			fdata_p->line_type = T_COM_MES; // ëOçsÇÃ∫“›ƒà íuÇ…çáÇÌÇπÇÈ
			strcpy( buf, "//" );
			if( fdata_p->mes[0] != ' ' && fdata_p->mes[0] != _SOH ) strcat( buf, " " );
			strcat( buf, fdata_p->mes );	// ñ{ï∂Çcopy
			strcpy( fdata_p->mes, buf );	// ñ{ï∂ÇñﬂÇ∑
			fdata_p->com_teigi_no = 0;
			fdata_p->pri_comment[0] = 0;
		}
		if( fdata_p->line_type == T_MES15 || (fdata_p->hojo_flag & H_BIG_K_L) ) com_pos = 0;
		else com_pos = fdata_p->src_com_pos; // ∫“›ƒÇÃtopà íuÇsave
	}

	crlf_cnt = 1; // òAë±â¸çsêî. ç≈èâÇÃâ¸çsÇÕçÌèú
	line_last = 0;
	for( line_no = 0; line_no < max_line; line_no++ )
	{ // fdata_p Ç≈ÇÕèdï°Ç∑ÇÈÇÃÇ≈ÅAÇ±Ç±Ç≈ÇÕfdataégóp
		fdata = &ope_buf[line_no];

#ifdef _DEBUG
		if( line_no >= 7816 )
		{
			debug_n = (int)fdata->mes;
		}
#endif

		if( line_no >= line_last && fdata->line_type != T_CRLF )
		{ // í≤ç∏
			base_type = chk_tab_enable( line_no ); // TABï‚ê≥ÇÃïKóvê´ÇämîF
			if( fdata->hojo_flag & (H_YEN1 | H_YEN2) ) base_type = G_YEN;

			if( base_type )
			{ // ------------ òAë±Ç∑ÇÈìØÇ∂typeÇí≤Ç◊ÇÈ ---------------
				for( line_last = line_no; line_last < max_line; line_last++ )
				{
					fdata_p = &ope_buf[line_last];

#ifdef _DEBUG
					if( line_last >= 77 )
					{
						debug_n = (int)fdata_p->mes;
					}
#endif
					if( fdata_p->line_type == T_CRLF ) continue;
					if( fdata_p->line_type == T_COM_MES ) continue;
					if( fdata_p->line_type == T_DEFIF ) continue;
//					if( fdata_p->line_type == T_MES15 ) continue;
					if( base_type != G_TYPE_IN && (fdata_p->hojo_flag & H_MES15) ) continue;
					if( base_type != G_YEN )
					{
						if( fdata_p->hojo_flag & (H_YEN1 | H_YEN2) ) break; // 2012.08.31
					}
					cur_type = chk_tab_enable( line_last );
					if( fdata_p->hojo_flag & (H_YEN1 | H_YEN2) ) cur_type = G_YEN;

					if( base_type == G_DEFINE )
					{
						if( fdata_p->line_type == T_MES14 || fdata_p->line_type == T_MES15 )
						{
							tmp_type = fdata_p->line_type;
							if( chk_same_teigi(base_type, tmp_type, &line_last, max_line) == 0 ) break;
							continue;
						}
						if( base_type != cur_type ) break;
					}
					else if( base_type == G_TYPE_IN )
					{
//						if( fdata_p->tab_pos && fdata_p->line_type == T_BIG_KAKKO ) continue; // 2013.10.10
						if( base_type != cur_type ) break;
					}
					else if( base_type & G_TYPE1 )
					{
						if( fdata_p->line_type == T_OTHER ) continue;
						if( fdata_p->line_type == T_STRUCT ) continue;	// 2013.10.01
						if( fdata_p->line_type == T_UNION ) continue;	// 2013.10.07
						if( fdata_p->line_type == T_MES14 || fdata_p->line_type == T_MES15 )
						{
							tmp_type = fdata_p->line_type;
							if( chk_same_teigi(base_type, tmp_type, &line_last, max_line) == 0 ) break;
							continue;
						}
						if( base_type != cur_type ) break;
					}
					else if( base_type & G_TYPE2 )
					{
						if( fdata_p->line_type == T_MES14 || fdata_p->line_type == T_MES15 )
						{
							tmp_type = fdata_p->line_type;
							if( chk_same_teigi(base_type, tmp_type, &line_last, max_line) == 0 ) break;
							continue;
						}
						if( base_type != cur_type ) break;
					}
					else if( base_type == G_B_K_PAIR )
					{
						if( base_type != cur_type ) break;
					}
					else if( base_type == G_DIGIT )
					{
						if( fdata_p->line_type == T_OTHER ) continue;
						if( fdata_p->line_type == T_MES14 || fdata_p->line_type == T_MES15 )
						{
							tmp_type = fdata_p->line_type;
							if( chk_same_teigi(base_type, tmp_type, &line_last, max_line) == 0 ) break;
							continue;
						}
						if( base_type != cur_type ) break;
					}
					else if( base_type == G_OTHER )
					{
						if( fdata_p->line_type == T_DIGIT ) continue;
						if( fdata_p->line_type == T_MOJIS ) continue;
						if( base_type != cur_type )
						{
							if( form_other_com_tab >= 2 && cur_type == G_IF ) continue;
							else break;
						}
					}
					else if( base_type == G_IF )
					{
						if( base_type != cur_type )
						{
							if( form_other_com_tab >= 2 && cur_type == G_OTHER ) continue;
							else break;
						}
					}
					else if( base_type == G_STRUCT1 || base_type == G_STRUCT2 )
					{
						if( base_type != cur_type && fdata_p->tab_pos == 0 ) break;
					}
//					else if( base_type == G_EXTERN )
//					{
//						if( base_type != cur_type ) break;
//					}
					else if( base_type == G_DEF_OTHER || base_type == G_TYPEDEF )
					{
						if( fdata_p->line_type == T_MOJIS ) continue;
						if( fdata_p->line_type == T_MES14 || fdata_p->line_type == T_MES15 )
						{
							tmp_type = fdata_p->line_type;
							if( chk_same_teigi(base_type, tmp_type, &line_last, max_line) == 0 ) break;
							continue;
						}
						if( base_type != cur_type ) break;
					}
//					else if( base_type == G_MOJIS && cur_type == G_TYPE_IN ) continue;
					else { // ÇªÇÃëº, G_STRUCT, G_CASE, G_INCLUDE, G_ASM, G_YEN, G_PROC
						if( base_type != cur_type ) break;
					}
				}
#ifdef _DEBUG
				if( line_no >= 7816 )
				{
					debug_n = 0;
				}
#endif
				if( line_no < line_last )
				{ // 2çsà»è„
					if( base_type == G_ASM ) g_asm_syori( base_type, line_no, line_last );
					else ajust_tab( base_type, line_no, line_last ); // ìØóﬁÇÃòAë±ÇTABÇ≈ÇªÇÎÇ¶ÇÈ
				}
			}
		}

		if( fdata->pri_comment[0] )
//		if( (fdata->hojo_flag & H_MES17) == 0 && fdata->pri_comment[0] )
		{
			strcpy( buf, fdata->pri_comment );
			len = strlen( buf );
			if( buf[len - 1] != _SOH && buf[len - 1] != ' ' &&
				fdata->mes[0] != _SOH && fdata->mes[0] != ' ' ) strcat( buf, " " );
			strcat( buf, fdata->mes );
		}
		else strcpy( buf, fdata->mes );
		cut_last_space( 1, buf );	// ç≈å„ÇÃTAB,spaceÇçÌèú

		chg_soh_tab( 1, buf );		// ãÊêÿÇËÇÃΩÕﬂ∞ΩÇTABÇ…ïœä∑

		if( fp_dbg != NULL )
		{
			strcpy( dbg_buf, buf );
			disp_debug_para2( dbg_buf );
		}
		strcat( buf, "\r\n" );
		if( font_type == 1 )
		{ // 0:é©ìÆ, 1:utf8, 2:Shift JIS
			srcSJIS_out = SjistoUTF8( (string)buf );
			strcpy( buf, srcSJIS_out.c_str() );
		}
//		save_error_file( buf ); // ãLò^ zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz

		if( fp_dbg != NULL ) strcat( dbg_buf, "\r\n" );
		len = strlen( buf );
		if( len > 2 )
		{
			fwrite( buf, sizeof(char), len, fp_dst );
			if( fp_dbg != NULL )
			{
				len = strlen( dbg_buf );
				fwrite( dbg_buf, sizeof(char), len, fp_dbg );
			}
			crlf_cnt = 0; // reset
		}
		else if( ++crlf_cnt < 2 )
		{ // òAë±Ç∑ÇÈLFÇÕñ≥éã
			fwrite( buf, sizeof(char), len, fp_dst );
			if( fp_dbg != NULL )
			{
				len = strlen( dbg_buf );
				fwrite( dbg_buf, sizeof(char), len, fp_dbg );
			}
		}
	}
	fclose( fp_dst );
	if( fp_dbg != NULL ) fclose( fp_dbg );
	// ------------------ ø∞ΩÃß≤ŸÇ∆î‰är ------------------
	fp_src = fopen( src_name, "rb+" );
	if( fp_src == NULL )
	{
		DeleteFile( tmp_name ); // çÌèú
		printf( "Fatal: can't open file:%s\n", src_name );
		wait_exit( 1 );
	}

	fp_dst = fopen( tmp_name, "rb+" );
	if( fp_dst == NULL )
	{
		fclose( fp_src );
		fp_src = NULL;
//		DeleteFile( tmp_name ); // çÌèú
		printf( "Fatal: can't open file:%s\n", tmp_name );
		wait_exit( 1 );
	}
//	fseek( fp_src, 0, SEEK_SET ); // ñﬂÇ∑
//	fseek( fp_dst, 0, SEEK_SET ); // ñﬂÇ∑

	line_no = 0;
	syori_cnt = 0;
	for(;;)
	{
		len = getln( fp_src, r_buf, CHAR_SIZE2 );				// Ãß≤ŸÇ©ÇÁâ¸çsï∂éöÇ‹Ç≈éÊÇËçûÇﬁ(CR+LF-->LF)
		line_no++;
		n = getln( fp_dst, w_buf, CHAR_SIZE2 );					// Ãß≤ŸÇ©ÇÁâ¸çsï∂éöÇ‹Ç≈éÊÇËçûÇﬁ(CR+LF-->LF)
		if( r_buf[0] == 0 && w_buf[0] == 0 ) break;				// OK
		if( n != len ) syori_cnt++;								// ïsàÍív
		else if( memcmp(r_buf, w_buf, len) != 0 ) syori_cnt++;	// ïsàÍív
	}
	if( fp_src != NULL ) fclose( fp_src );
	fp_src = NULL;
	fclose( fp_dst );

	if( debug_mode == 0 )
	{
		switch( form_source_name )
		{
		case 0: // ø∞ΩñºÇÃèàóù 0:åüç∏ÇÃÇ›
			break;

		case 1: // ïœçX ø∞ΩñºÇÃèàóù 1:ø∞ΩñºÇÕïœÇÌÇÁÇ∏+.newÇêVãKÇ…çÏÇÈ
			DeleteFile( new_name );									// çÌèú
			if( syori_cnt != 0 ) MoveFile( tmp_name, new_name );	// ïœçX
			break;

		case 2: // ø∞ΩñºÇÃèàóù 2:ø∞ΩñºÇ+.oldÇ∆Ç∑ÇÈ
			DeleteFile( old_name ); // çÌèú
			if( syori_cnt != 0 )
			{
				MoveFile( src_name, old_name ); // ïœçX ø∞ΩñºÇÃèàóù 2:ø∞ΩñºÇ+.oldÇ∆Ç∑ÇÈ
				MoveFile( tmp_name, src_name ); // ïœçX
			}
			break;

		case 3: // ø∞ΩñºÇÃèàóù 3:oldÇçÏÇÁÇ»Ç¢
			DeleteFile( old_name ); // çÌèú
			if( syori_cnt != 0 )
			{
				MoveFile( src_name, old_name ); // àÍéûìIÇ…rename
				MoveFile( tmp_name, src_name ); // ïœçX
				DeleteFile( old_name );			// çÌèú
			}
			break;
		}
	}
	DeleteFile( tmp_name ); // çÌèú
	return( syori_cnt );
}
// ------------------------------------------
// utf8 to shiftJIS
// ------------------------------------------
std::string UTF8toSjis( std::string srcUTF8 )
{
	// UnicodeÇ÷ïœä∑å„ÇÃï∂éöóÒí∑ÇìæÇÈ
	int lenghtUnicode = MultiByteToWideChar( CP_UTF8, 0, srcUTF8.c_str(), srcUTF8.size() + 1, NULL, 0 );

	// ïKóvÇ»ï™ÇæÇØUnicodeï∂éöóÒÇÃÉoÉbÉtÉ@Çämï€
	wchar_t *bufUnicode = new wchar_t[lenghtUnicode];

	// UTF8Ç©ÇÁUnicodeÇ÷ïœä∑
	MultiByteToWideChar( CP_UTF8, 0, srcUTF8.c_str(), srcUTF8.size() + 1, bufUnicode, lenghtUnicode );

	// ShiftJISÇ÷ïœä∑å„ÇÃï∂éöóÒí∑ÇìæÇÈ
	int lengthSJis = WideCharToMultiByte( CP_THREAD_ACP, 0, bufUnicode, -1, NULL, 0, NULL, NULL );

	// ïKóvÇ»ï™ÇæÇØShiftJISï∂éöóÒÇÃÉoÉbÉtÉ@Çämï€
	char *bufShiftJis = new char[lengthSJis];

	// UnicodeÇ©ÇÁShiftJISÇ÷ïœä∑
	WideCharToMultiByte( CP_THREAD_ACP, 0, bufUnicode, lenghtUnicode + 1, bufShiftJis, lengthSJis, NULL, NULL );

	std::string strSJis( bufShiftJis );

	delete bufUnicode;
	delete bufShiftJis;

	return( strSJis );
}

// ------------------------------------------
// shiftJIS to utf8
// ------------------------------------------
std::string SjistoUTF8( std::string srcSjis )
{
	// UnicodeÇ÷ïœä∑å„ÇÃï∂éöóÒí∑ÇìæÇÈ
	int lenghtUnicode = MultiByteToWideChar( CP_THREAD_ACP, 0, srcSjis.c_str(), srcSjis.size() + 1, NULL, 0 );

	// ïKóvÇ»ï™ÇæÇØUnicodeï∂éöóÒÇÃÉoÉbÉtÉ@Çämï€
	wchar_t* bufUnicode = new wchar_t[lenghtUnicode];

	// ShiftJISÇ©ÇÁUnicodeÇ÷ïœä∑
	MultiByteToWideChar( CP_THREAD_ACP, 0, srcSjis.c_str(), srcSjis.size() + 1, bufUnicode, lenghtUnicode );

	// UTF8Ç÷ïœä∑å„ÇÃï∂éöóÒí∑ÇìæÇÈ
	int lengthUTF8 = WideCharToMultiByte( CP_UTF8, 0, bufUnicode, -1, NULL, 0, NULL, NULL );

	// ïKóvÇ»ï™ÇæÇØUTF8ï∂éöóÒÇÃÉoÉbÉtÉ@Çämï€
	char* bufUTF8 = new char[lengthUTF8];

	// UnicodeÇ©ÇÁUTF8Ç÷ïœä∑
	WideCharToMultiByte( CP_UTF8, 0, bufUnicode, lenghtUnicode + 1, bufUTF8, lengthUTF8, NULL, NULL );

	std::string strUTF8( bufUTF8 );

	delete bufUnicode;
	delete bufUTF8;

	return( strUTF8 );
}
